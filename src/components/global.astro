<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAltYkTpdrIShVv7wJXsszQqvOZXTC45Wg",
        authDomain: "baudepromocao-oficial.firebaseapp.com",
        projectId: "baudepromocao-oficial",
        storageBucket: "baudepromocao-oficial.firebasestorage.app",
        messagingSenderId: "743146859125",
        appId: "1:743146859125:web:6d1f5331e22b8ce981263c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // --- LÓGICA DO MENU ---
    window.toggleMenu = () => {
        const menu = document.getElementById('sideMenu') || document.getElementById('mobileMenu');
        const overlay = document.getElementById('menuOverlay');
        const btn = document.querySelector('.hamburger-btn');
        
        if (!menu || !overlay) return;

        const isActive = menu.classList.toggle('active');
        overlay.classList.toggle('active');
        
        if (btn) {
            btn.classList.add('active');
            if (isActive) {
                setTimeout(() => btn.classList.remove('active'), 1000);
            } else {
                btn.classList.remove('active');
            }
        }
        document.body.style.overflow = isActive ? 'hidden' : 'auto';
    };

    // --- LÓGICA DE AUTENTICAÇÃO ---
    let isSignUpMode = false;

    window.openAuthModal = () => {
        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'flex';
        // Fecha o menu ao abrir o login
        const menu = document.getElementById('sideMenu') || document.getElementById('mobileMenu');
        if (menu) menu.classList.remove('active');
        if (document.getElementById('menuOverlay')) document.getElementById('menuOverlay').classList.remove('active');
        document.body.style.overflow = 'auto';
    };
    
    window.closeAuthModal = () => {
        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'none';
    };

    window.toggleAuthMode = () => {
        isSignUpMode = !isSignUpMode;
        document.getElementById('authTitle').innerText = isSignUpMode ? 'Criar Conta' : 'Fazer Login';
        document.getElementById('mainAuthBtn').innerText = isSignUpMode ? 'Cadastrar' : 'Entrar';
        document.getElementById('authToggle').innerText = isSignUpMode ? 'Já tem conta? Login.' : 'Não tem conta? Cadastre-se.';
    };

    window.handleEmailAuth = async () => {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        
        if (!email || !password) {
            alert("Preencha todos os campos");
            return;
        }

        try {
            if (isSignUpMode) {
                await createUserWithEmailAndPassword(auth, email, password);
            } else {
                await signInWithEmailAndPassword(auth, email, password);
            }
            closeAuthModal();
        } catch (e) { 
            alert("Erro: " + e.message); 
        }
    };

    window.signInWithGoogle = () => signInWithPopup(auth, provider).then(closeAuthModal).catch(console.error);
    window.logout = () => signOut(auth);

    // --- MONITORAMENTO DE ESTADO ---
    onAuthStateChanged(auth, (user) => {
        const loginBtn = document.getElementById('loginBtn');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userPhoto = document.getElementById('userPhoto');
        
        if (user) {
            if (loginBtn) loginBtn.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex';
            if (userName) userName.innerText = user.displayName ? user.displayName.split(' ')[0] : 'Usuário';
            if (userPhoto) userPhoto.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=random`;
        } else {
            if (loginBtn) loginBtn.style.display = 'block';
            if (userInfo) userInfo.style.display = 'none';
        }
    });

    // --- CLIQUES FORA (FECHAR MODAL) ---
    window.addEventListener('click', (event) => {
        const authModal = document.getElementById('authModal');
        const donationModal = document.getElementById('donationModal');
        const overlay = document.getElementById('menuOverlay');

        if (event.target === authModal) closeAuthModal();
        if (event.target === donationModal && typeof toggleModal === 'function') toggleModal();
        if (event.target === overlay) window.toggleMenu();
    });
</script>