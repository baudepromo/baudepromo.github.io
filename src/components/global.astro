<script type="module">
    // Importa as fun√ß√µes do arquivo que criamos
    import { 
        initFirebase, 
        loginWithGoogle, 
        loginWithEmail, 
        registerWithEmail, 
        logoutUser 
    } from './lib/firebase/firebase.js';

    // -----------------------------------------------------------
    // 1. Estado Local da UI
    // -----------------------------------------------------------
    let isSignUpMode = false;

    // -----------------------------------------------------------
    // 2. Atualiza√ß√£o da Interface (UI)
    // -----------------------------------------------------------
    function updateUIState(user) {
        const loginBtn = document.getElementById('loginBtn');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userPhoto = document.getElementById('userPhoto');
        
        if (user) {
            if (loginBtn) loginBtn.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex';
            
            const nameToDisplay = user.displayName ? user.displayName.split(' ')[0] : user.email.split('@')[0];
            if (userName) userName.innerText = nameToDisplay;
            
            if (userPhoto) {
                const photoUrl = user.photoURL || `https://ui-avatars.com/api/?name=${nameToDisplay}&background=007bff&color=fff`;
                if (userPhoto.src !== photoUrl) userPhoto.src = photoUrl;
            }
            
            localStorage.setItem('isUserLoggedIn', 'true');
            console.log("üë§ UI Atualizada: Logado como", user.email);
        } else {
            if (loginBtn) loginBtn.style.display = 'block';
            if (userInfo) userInfo.style.display = 'none';
            localStorage.removeItem('isUserLoggedIn');
            console.log("üë§ UI Atualizada: Deslogado");
        }
    }

    // -----------------------------------------------------------
    // 3. Fun√ß√µes Globais (Window)
    // -----------------------------------------------------------
    // Como √© um m√≥dulo, precisamos anexar explicitamente ao window
    
    window.openAuthModal = async () => {
        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'flex';
        
        // Fecha menu mobile se existir
        const menu = document.getElementById('sideMenu');
        const overlay = document.getElementById('menuOverlay');
        if (menu) menu.classList.remove('active');
        if (overlay) overlay.classList.remove('active');

        // Inicia o Firebase se ainda n√£o foi iniciado
        document.body.style.cursor = 'wait';
        try {
            // Passamos updateUIState como callback para ser chamado quando o status mudar
            await initFirebase(updateUIState);
        } catch (e) {
            console.error(e);
        } finally {
            document.body.style.cursor = 'default';
        }
    };

    window.closeAuthModal = () => {
        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'none';
    };

    window.toggleAuthMode = () => {
        isSignUpMode = !isSignUpMode;
        document.getElementById('authTitle').innerText = isSignUpMode ? 'Criar Conta' : 'Fazer Login';
        document.getElementById('mainAuthBtn').innerText = isSignUpMode ? 'Cadastrar' : 'Entrar';
        document.getElementById('authToggle').innerText = isSignUpMode ? 'J√° tem conta? Login.' : 'N√£o tem conta? Cadastre-se.';
    };

    window.signInWithGoogle = async () => {
        try {
            await loginWithGoogle();
            window.closeAuthModal();
        } catch (error) {
            console.error(error);
            alert('Erro no login Google: ' + error.message);
        }
    };

    window.handleEmailAuth = async () => {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;

        if (!email || !password) return alert("Preencha todos os campos");

        try {
            if (isSignUpMode) {
                await registerWithEmail(email, password);
            } else {
                await loginWithEmail(email, password);
            }
            window.closeAuthModal();
        } catch (e) {
            alert("Erro: " + e.message);
        }
    };

    window.logout = async () => {
        await logoutUser();
        // O updateUIState ser√° chamado automaticamente pelo listener do Firebase,
        // mas podemos for√ßar um reload se preferir limpar tudo
        window.location.reload();
    };

    window.toggleMenu = () => {
        const menu = document.getElementById('sideMenu') || document.getElementById('mobileMenu');
        const overlay = document.getElementById('menuOverlay');
        const btn = document.querySelector('.hamburger-btn');
        
        if (!menu || !overlay) return;

        const isActive = menu.classList.toggle('active');
        overlay.classList.toggle('active');
        
        if (btn) {
            btn.classList.add('active');
            if (isActive) {
                setTimeout(() => btn.classList.remove('active'), 1000);
            } else {
                btn.classList.remove('active');
            }
        }
        document.body.style.overflow = isActive ? 'hidden' : 'auto';
    };

    // -----------------------------------------------------------
    // 4. Inicializa√ß√£o Imediata (Cache Local)
    // -----------------------------------------------------------
    window.addEventListener('DOMContentLoaded', () => {
        // Verifica cache manual para UI otimista
        const hasLocalCache = localStorage.getItem('isUserLoggedIn') === 'true';

        if (hasLocalCache) {
            console.log("‚ö° Restaurando sess√£o visualmente (Cache)...");
            
            // Simula um objeto de usu√°rio m√≠nimo apenas para mostrar a UI correta
            // at√© o Firebase carregar de verdade
            const mockUser = { 
                email: 'Carregando...', 
                displayName: '...', 
                photoURL: null 
            };
            
            // Atualiza a UI imediatamente
            updateUIState(mockUser);
            
            // Inicia o download do Firebase em background passando a fun√ß√£o real de atualiza√ß√£o
            initFirebase(updateUIState).then(({auth}) => {
                // Quando carregar, se tiver usu√°rio real, a UI atualiza com a foto/nome certos
                if (auth.currentUser) updateUIState(auth.currentUser);
            });
        }
    });
</script>