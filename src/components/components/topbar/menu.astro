<div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>

<nav id="sideMenu" class="mobile-menu" aria-label="Menu Principal">
    <button class="close-menu" onclick="toggleMenu()" aria-label="Fechar menu">&times;</button>

    <div class="menu-links">
        <a href="/"><span>â¬…ï¸</span> InÃ­cio</a>
        <a href="/achadinhos"><span>ğŸ›’</span> Achadinhos</a>
        <a href="/produtos"><span>ğŸ“¦</span> Produtos</a>
        <a href="/cupons"><span>ğŸ«</span> Cupons</a>
    </div>

    <hr class="menu-divider">

    <div class="menu-links-secondary">
        <a href="/sobre"><span>â„¹ï¸</span> Sobre</a>
        <a href="/faq"><span>ğŸ’¬</span> FAQ</a>
        <a href="/contatos"><span>âœ‰ï¸</span> Contato</a>
        <a href="/afiliados"><span>ğŸ¤</span> Afiliados</a>
        <a href="/politica-de-privacidade"><span>ğŸ‘¤</span> PolÃ­tica de Privacidade</a>
        <a href="/termos-de-uso"><span>âš–ï¸</span> Termos de Uso</a>
    </div>

    <div class="auth-container">
        <button id="loginBtn" class="btn-login" onclick="openAuthModal()">
            Entrar
        </button>

        <div id="userInfo" class="user-profile" style="display: none;">
            <img id="userPhoto" src="" alt="Foto do UsuÃ¡rio">
            <div class="user-details">
                <span id="userName">UsuÃ¡rio</span>
                <small onclick="logout()" class="logout-link" style="cursor: pointer; color: #ff4d4d;">Sair</small>
            </div>
        </div>
    </div>
</nav>

<script type="module">

    // --- 1. FunÃ§Ãµes de Interface (UI) ---

    /**
     * Atualiza o menu lateral com base no estado do usuÃ¡rio
     */
    function updateMenuUI(user) {
        const loginBtn = document.getElementById('loginBtn');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userPhoto = document.getElementById('userPhoto');

        if (user) {
            // UsuÃ¡rio Logado
            if (loginBtn) loginBtn.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex';

            // Extrai metadados (Google ou Cadastro Manual)
            const metadata = user.user_metadata || {};
            const nameToDisplay = metadata.full_name || metadata.name || user.email.split('@')[0];
            const photoUrl = metadata.avatar_url || metadata.picture || `https://ui-avatars.com/api/?name=${nameToDisplay}&background=007bff&color=fff`;

            if (userName) userName.innerText = nameToDisplay;
            if (userPhoto) userPhoto.src = photoUrl;

        } else {
            // UsuÃ¡rio Deslogado
            if (loginBtn) loginBtn.style.display = 'block';
            if (userInfo) userInfo.style.display = 'none';
        }
    }

    // --- 2. FunÃ§Ãµes Globais (Expostas para o Window) ---

    // Abre/Fecha o menu lateral
    window.toggleMenu = () => {
        const menu = document.getElementById('sideMenu');
        const overlay = document.getElementById('menuOverlay');
        if (menu && overlay) {
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }
    };

    // FunÃ§Ã£o de Logout integrada ao Supabase
    window.logout = async () => {
        try {
            const { error } = await supabase.auth.signOut();
            if (error) throw error;
            
            // Fecha o menu apÃ³s deslogar
            window.toggleMenu();
            // Recarrega para limpar estados residuais (opcional)
            window.location.reload(); 
        } catch (error) {
            console.error("Erro ao sair:", error.message);
        }
    };

    window.openAuthModal = () => {
        const modal = document.getElementById('authModal');
        if (modal) {
            modal.style.display = 'flex';
        } else {
            console.error("Modal 'authModal' nÃ£o encontrado no DOM");
        }
        
        // Fecha o menu lateral se estiver aberto
        const menu = document.getElementById('sideMenu');
        if (menu) menu.classList.remove('active');
        const overlay = document.getElementById('menuOverlay');
        if (overlay) overlay.classList.remove('active');
    };

    window.closeAuthModal = () => {
        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'none';
    };
    // --- 3. Listeners de AutenticaÃ§Ã£o ---

    // Ouve mudanÃ§as de estado em tempo real (Login/Logout)
    supabase.auth.onAuthStateChange((event, session) => {
        console.log("Evento Auth Menu:", event);
        updateMenuUI(session?.user ?? null);
    });

    // VerificaÃ§Ã£o inicial de sessÃ£o ao carregar a pÃ¡gina
    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabase.auth.getSession();
        updateMenuUI(session?.user ?? null);
    });
</script>