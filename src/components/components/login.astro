---
import '../../styles/components/login.css'
---
<div id="authModal" class="modal-overlay" onclick="if(event.target === this) closeAuthModal()">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAuthModal()">&times;</span>
            <h2 id="authTitle" style="margin-bottom: 20px;">Fazer Login</h2>
            
            <input type="email" id="authEmail" placeholder="Seu e-mail">
            <input type="password" id="authPassword" placeholder="Sua senha">
            
            <button id="mainAuthBtn" class="main-auth-btn" onclick="handleEmailAuth()">Entrar</button>
            
            <p id="authToggle" onclick="toggleAuthMode()" style="cursor: pointer; color: #007bff; font-size: 0.9em; margin-top: 10px;">
                N√£o tem conta? Cadastre-se.
            </p>

            <hr style="margin: 20px 0; border-top: 1px solid #eee;">

            <button class="google-btn" onclick="signInWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18" alt="Google"> 
                Continuar com Google
            </button>
        </div>
</div>
<script type="module">
    // -----------------------------------------------------------
    // 1. Defini√ß√µes Globais
    // -----------------------------------------------------------
    let app, auth, provider;
    let authModule, appModule;
    let isFirebaseLoaded = false;
    let isSignUpMode = false;

    const firebaseConfig = {
        apiKey: "AIzaSyAltYkTpdrIShVv7wJXsszQqvOZXTC45Wg",
        authDomain: "baudepromocao-oficial.firebaseapp.com",
        projectId: "baudepromocao-oficial",
        storageBucket: "baudepromocao-oficial.firebasestorage.app",
        messagingSenderId: "743146859125",
        appId: "1:743146859125:web:6d1f5331e22b8ce981263c"
    };

    // -----------------------------------------------------------
    // 2. Carregamento Inteligente do Firebase
    // -----------------------------------------------------------
    async function loadFirebase() {
        if (isFirebaseLoaded) return;

        console.log("‚è≥ Baixando Firebase...");
        
        try {
            // Importa√ß√£o Din√¢mica
            [appModule, authModule] = await Promise.all([
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"),
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js")
            ]);

            // Inicializa√ß√£o
            app = appModule.initializeApp(firebaseConfig);
            auth = authModule.getAuth(app);
            provider = new authModule.GoogleAuthProvider();
            isFirebaseLoaded = true;

            // --- A CORRE√á√ÉO M√ÅGICA ---
            // Isso trava o c√≥digo aqui at√© o Firebase ler o banco de dados do navegador
            // e ter 100% de certeza se o usu√°rio est√° logado ou n√£o.
            await auth.authStateReady(); 

            // Agora que temos certeza, atualizamos a tela com a verdade
            updateUIState(auth.currentUser);

            // E deixamos o vigia ligado para mudan√ßas futuras
            authModule.onAuthStateChanged(auth, updateUIState);

            console.log("‚úÖ Firebase sincronizado com sucesso!");

        } catch (error) {
            console.error("Erro cr√≠tico no Firebase:", error);
            // Se der erro de conex√£o, garante que a UI n√£o trave em estado estranho
            updateUIState(null);
        }
    }

    // -----------------------------------------------------------
    // 3. Atualiza√ß√£o da Interface (UI)
    // -----------------------------------------------------------
    function updateUIState(user) {
        const loginBtn = document.getElementById('loginBtn');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userPhoto = document.getElementById('userPhoto');
        
        if (user) {
            // 1. Garante que o container esteja vis√≠vel
            if (loginBtn) loginBtn.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex';
            
            // 2. Atualiza o Nome (Pega o primeiro nome ou parte do email se n√£o tiver nome)
            const nameToDisplay = user.displayName ? user.displayName.split(' ')[0] : user.email.split('@')[0];
            if (userName) userName.innerText = nameToDisplay;
            
            // 3. Atualiza a Foto
            if (userPhoto) {
                // Se o usu√°rio tem foto (Google), usa ela. Se n√£o, gera um avatar com a inicial.
                const photoUrl = user.photoURL || `https://ui-avatars.com/api/?name=${nameToDisplay}&background=007bff&color=fff`;
                
                // S√≥ atualiza se a foto for diferente para evitar que a imagem "pisque"
                if (userPhoto.src !== photoUrl) {
                    userPhoto.src = photoUrl;
                }
            }
            
            localStorage.setItem('isUserLoggedIn', 'true');
            console.log("üë§ Dados do usu√°rio carregados:", user.email);
        } else {
            // Se n√£o tem usu√°rio, limpa tudo
            if (loginBtn) loginBtn.style.display = 'block';
            if (userInfo) userInfo.style.display = 'none';
            localStorage.removeItem('isUserLoggedIn');
        }
    }

    // -----------------------------------------------------------
    // 4. Fun√ß√µes Exportadas para o HTML (Window)
    // -----------------------------------------------------------
    window.openAuthModal = async () => {
        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'flex';
        
        // Fecha o menu lateral mobile para melhor experi√™ncia
        const menu = document.getElementById('sideMenu');
        if (menu) menu.classList.remove('active');
        const overlay = document.getElementById('menuOverlay');
        if (overlay) overlay.classList.remove('active');

        if (!isFirebaseLoaded) {
            document.body.style.cursor = 'wait';
            await loadFirebase();
            document.body.style.cursor = 'default';
        }
    };

    window.closeAuthModal = () => {
        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'none';
    };

    window.toggleAuthMode = () => {
        isSignUpMode = !isSignUpMode;
        document.getElementById('authTitle').innerText = isSignUpMode ? 'Criar Conta' : 'Fazer Login';
        document.getElementById('mainAuthBtn').innerText = isSignUpMode ? 'Cadastrar' : 'Entrar';
        document.getElementById('authToggle').innerText = isSignUpMode ? 'J√° tem conta? Login.' : 'N√£o tem conta? Cadastre-se.';
    };

    window.signInWithGoogle = async () => {
        if (!isFirebaseLoaded) await loadFirebase();
        try {
            await authModule.signInWithPopup(auth, provider);
            window.closeAuthModal();
        } catch (error) {
            console.error(error);
            alert('Erro no login Google: ' + error.message);
        }
    };

    window.handleEmailAuth = async () => {
        if (!isFirebaseLoaded) await loadFirebase();
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;

        if (!email || !password) return alert("Preencha todos os campos");

        try {
            if (isSignUpMode) {
                await authModule.createUserWithEmailAndPassword(auth, email, password);
            } else {
                await authModule.signInWithEmailAndPassword(auth, email, password);
            }
            window.closeAuthModal();
        } catch (e) {
            alert("Erro: " + e.message);
        }
    };

    window.logout = async () => {
        if (!isFirebaseLoaded) await loadFirebase();
        await authModule.signOut(auth);
        localStorage.removeItem('isUserLoggedIn'); // Limpa cache manual
        window.location.reload();
    };

    // -----------------------------------------------------------
    // 5. Inicializa√ß√£o Imediata (DOMContentLoaded)
    // -----------------------------------------------------------
    window.addEventListener('DOMContentLoaded', () => {
        // Verifica nosso cache manual (mais r√°pido que esperar o Firebase)
        // Nota: Mudei a verifica√ß√£o para ser mais simples e direta
        const hasLocalCache = localStorage.getItem('isUserLoggedIn') === 'true' || 
                              Object.keys(localStorage).some(key => key.startsWith('firebase:authUser'));

        if (hasLocalCache) {
            console.log("‚ö° Restaurando sess√£o visualmente...");
            
            // TRUQUE VISUAL: Mostra o menu ANTES do Firebase carregar
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            
            if (loginBtn) loginBtn.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex'; 
            
            // Inicia o download do Firebase em segundo plano
            loadFirebase();
        }
    });
</script>