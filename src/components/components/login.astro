---
import '../../styles/components/login.css'
---
<div id="authModal" class="modal-overlay" onclick="if(event.target === this) closeAuthModal()">
    <div class="modal-content">
        <span class="close-modal" onclick="closeAuthModal()">&times;</span>
        <h2 id="authTitle" style="margin-bottom: 20px;">Fazer Login</h2>
        
        <input type="email" id="authEmail" placeholder="Seu e-mail">
        <input type="password" id="authPassword" placeholder="Sua senha">
        
        <button id="mainAuthBtn" class="main-auth-btn" onclick="handleEmailAuth()">Entrar</button>
        
        <p id="authToggle" onclick="toggleAuthMode()" style="cursor: pointer; color: #007bff; font-size: 0.9em; margin-top: 10px;">
            N칚o tem conta? Cadastre-se.
        </p>

        <hr style="margin: 20px 0; border-top: 1px solid #eee;">

        <button class="google-btn" onclick="signInWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18" alt="Google"> 
            Continuar com Google
        </button>
    </div>
</div>

<script type="module">
    // 1. Importa o cliente Supabase configurado
    import { supabase } from '../../lib/supabase';

    // 2. Estado local
    let isSignUpMode = false;

    // -----------------------------------------------------------
    // 3. Atualiza칞칚o da Interface (UI)
    // -----------------------------------------------------------
    function updateUIState(user) {
        const loginBtn = document.getElementById('loginBtn');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userPhoto = document.getElementById('userPhoto');
        
        if (user) {
            if (loginBtn) loginBtn.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex';
            
            // Supabase armazena dados extras em user_metadata
            const metadata = user.user_metadata || {};
            const nameToDisplay = metadata.full_name || metadata.name || user.email.split('@')[0];
            
            if (userName) userName.innerText = nameToDisplay;
            
            if (userPhoto) {
                const photoUrl = metadata.avatar_url || metadata.picture || `https://ui-avatars.com/api/?name=${nameToDisplay}&background=007bff&color=fff`;
                if (userPhoto.src !== photoUrl) {
                    userPhoto.src = photoUrl;
                }
            }
            
            console.log("游녻 Usu치rio logado via Supabase:", user.email);
        } else {
            if (loginBtn) loginBtn.style.display = 'block';
            if (userInfo) userInfo.style.display = 'none';
        }
    }

    // -----------------------------------------------------------
    // 4. Inicializa칞칚o e Listeners
    // -----------------------------------------------------------
    
    // Verifica sess칚o atual ao carregar
    supabase.auth.getSession().then(({ data: { session } }) => {
        updateUIState(session?.user ?? null);
    });

    // Ouve mudan칞as de estado (Login, Logout, Refresh)
    supabase.auth.onAuthStateChange((_event, session) => {
        updateUIState(session?.user ?? null);
    });

    // -----------------------------------------------------------
    // 5. Fun칞칫es Expostas para o Window (para funcionar com onclick)
    // -----------------------------------------------------------

    window.openAuthModal = () => {
        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'flex';
        
        // Fecha menu mobile se existir
        const menu = document.getElementById('sideMenu');
        if (menu) menu.classList.remove('active');
        const overlay = document.getElementById('menuOverlay');
        if (overlay) overlay.classList.remove('active');
    };

    window.closeAuthModal = () => {
        const modal = document.getElementById('authModal');
        if (modal) modal.style.display = 'none';
    };

    window.toggleAuthMode = () => {
        isSignUpMode = !isSignUpMode;
        document.getElementById('authTitle').innerText = isSignUpMode ? 'Criar Conta' : 'Fazer Login';
        document.getElementById('mainAuthBtn').innerText = isSignUpMode ? 'Cadastrar' : 'Entrar';
        document.getElementById('authToggle').innerText = isSignUpMode ? 'J치 tem conta? Login.' : 'N칚o tem conta? Cadastre-se.';
    };

    window.signInWithGoogle = async () => {
        try {
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin // Redireciona para a mesma p치gina ap칩s login
                }
            });
            if (error) throw error;
            // O Supabase redirecionar치 a p치gina, ent칚o n칚o precisamos fechar o modal manualmente aqui
        } catch (error) {
            console.error(error);
            alert('Erro no login Google: ' + error.message);
        }
    };

    window.handleEmailAuth = async () => {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;

        if (!email || !password) return alert("Preencha todos os campos");

        try {
            let error;
            if (isSignUpMode) {
                // Cadastro
                const res = await supabase.auth.signUp({
                    email,
                    password,
                });
                error = res.error;
                if (!error && !res.data.session) {
                    alert("Verifique seu e-mail para confirmar o cadastro!");
                    window.closeAuthModal();
                    return;
                }
            } else {
                // Login
                const res = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                error = res.error;
            }

            if (error) throw error;
            window.closeAuthModal();

        } catch (e) {
            alert("Erro: " + e.message);
        }
    };

    window.logout = async () => {
        await supabase.auth.signOut();
        // O onAuthStateChange atualizar치 a UI automaticamente
        window.location.reload();
    };
</script>