---
// src/components/ProductCarousel.astro
const { title = "Produtos", tableName = "produtos", type } = Astro.props;
---
<div class="carousel-container" data-table={tableName}, data-type={type}>
    <div class="carousel-header">
        <h3>{title}</h3>
        <div class="carousel-controls">
            <button class="nav-btn btn-left" aria-label="Anterior">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <button class="nav-btn btn-right" aria-label="Próximo">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>
        </div>
    </div>

    <div class="carousel-track">
        <div class="card-skeleton"></div>
        <div class="card-skeleton"></div>
        <div class="card-skeleton"></div>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
    const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

    const supabase = createClient(supabaseUrl, supabaseKey);

    const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

    // Função para embaralhar array (Fisher-Yates Shuffle)
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    const carousels = document.querySelectorAll('.carousel-container');

    carousels.forEach(async (container) => {
        const tableName = container.dataset.table;
        const productType = container.dataset.type;
        const track = container.querySelector('.carousel-track');
        const btnLeft = container.querySelector('.btn-left');
        const btnRight = container.querySelector('.btn-right');
        
        let currentRangeStart = 0;
        const itemsPerLoad = 6;
        let isLoading = false;
        let allLoaded = false;
        let totalProductsCount = 0;

        // 1. Primeiro obtemos a contagem total para definir um início aleatório
        try {
            const { count, error } = await supabase
                .from(tableName)
                .select('*', { count: 'exact', head: true });
            
            if (!error && count > itemsPerLoad) {
                totalProductsCount = count;
                // Define um ponto de partida aleatório seguro
                // Ex: Se tem 100 produtos, começa entre 0 e 94
                currentRangeStart = Math.floor(Math.random() * (count - itemsPerLoad));
            }
        } catch (err) {
            console.error('Erro ao contar produtos:', err);
        }

        async function loadProducts() {
            if (isLoading || allLoaded) return;
            isLoading = true;

            // Se chegarmos ao fim da tabela, podemos voltar ao início (loop)
            // ou parar. Aqui ajustei para não quebrar se o range for maior que o total.
            
            const { data, error } = await supabase
                .from(tableName)
                .select('*')
                .range(currentRangeStart, currentRangeStart + itemsPerLoad - 1);

            if (error) { console.error('Erro:', error); isLoading = false; return; }
            
            // Limpa os skeletons na primeira carga
            if (track.querySelector('.card-skeleton')) track.innerHTML = '';
            
            if (data.length === 0) {
                allLoaded = true;
                isLoading = false;
                return;
            }

            // 2. Embaralha os produtos recebidos para não ficarem em ordem sequencial de ID
            const shuffledData = shuffleArray(data);

            shuffledData.forEach(product => {
                const card = document.createElement('a');
                card.className = 'carousel-card';
                card.href = `/${product.slug}/${productType}/${product.id}`;
                card.innerHTML = `
                    <div class="card-content">
                        <span class="shop-tag">${product.store || 'Destaque'}</span>
                        <h4 class="product-title">${product.title}</h4>
                        <div class="card-image-wrapper">
                            <img src="${product.img}" alt="${product.title}" loading="lazy" />
                        </div>
                        <div class="card-footer">
                            <div class="card-price">R$ ${product.price}</div>
                        </div>
                    </div>
                `;
                track.appendChild(card);
            });

            // Avança para o próximo lote sequencialmente a partir do ponto aleatório
            currentRangeStart += itemsPerLoad;
            
            // Se ultrapassar o total, volta para o início (efeito carrossel infinito)
            if (totalProductsCount > 0 && currentRangeStart >= totalProductsCount) {
                currentRangeStart = 0; 
            }

            isLoading = false;
        }

        // Inicializa
        loadProducts();

        // Eventos
        btnRight.addEventListener('click', () => {
            track.scrollBy({ left: track.offsetWidth * 0.8, behavior: 'smooth' });
        });

        btnLeft.addEventListener('click', () => {
            track.scrollBy({ left: -track.offsetWidth * 0.8, behavior: 'smooth' });
        });

        track.addEventListener('scroll', () => {
            const scrollRight = track.scrollWidth - track.scrollLeft - track.clientWidth;
            if (scrollRight < 300) loadProducts();
        });
    });
</script>

<style>
    :root {
        --card-bg: #ffffff;
        --primary: #e63946;
        --text-main: #2d3436;
        --text-muted: #95a5a6;
        --radius: 18px;
        --shadow: 0 10px 20px rgba(0,0,0,0.06);
    }

    .carousel-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px; /* Padding seguro para mobile */
    }

    .carousel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .carousel-header h3 {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--text-main);
        letter-spacing: -0.5px;
    }

    .carousel-controls {
        display: flex;
        gap: 8px;
    }

    /* Esconde setas no mobile para focar no toque, mostra no desktop */
    @media (max-width: 768px) {
        .carousel-controls { display: none; }
    }

    .nav-btn {
        background: white;
        border: 1px solid #eee;
        border-radius: 50%;
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .nav-btn:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
    }

    .carousel-track {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding: 10px 5px 30px 5px;
        scrollbar-width: none; 
        -ms-overflow-style: none;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }

    .carousel-track::-webkit-scrollbar { display: none; }

    /* Estilo do Card */
    :global(.carousel-card) {
        flex: 0 0 240px; /* Largura fixa no desktop */
        scroll-snap-align: start;
        text-decoration: none;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @media (max-width: 480px) {
        :global(.carousel-card) {
            flex: 0 0 75%; /* No mobile, mostra um pedaço do próximo card */
        }
    }

    :global(.carousel-card:hover) {
        transform: translateY(-8px);
    }

    :global(.card-content) {
        background: var(--card-bg);
        border-radius: var(--radius);
        padding: 18px;
        height: 100%;
        display: flex;
        flex-direction: column;
        border: 1px solid #f0f0f0;
        box-shadow: var(--shadow);
    }

    :global(.shop-tag) {
        font-size: 0.65rem;
        color: var(--primary);
        font-weight: 800;
        text-transform: uppercase;
        background: rgba(230, 57, 70, 0.1);
        padding: 4px 8px;
        border-radius: 6px;
        align-self: flex-start;
        margin-bottom: 10px;
    }

    :global(.product-title) {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-main);
        margin: 0 0 12px 0;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 2.8em;
    }

    :global(.card-image-wrapper) {
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
    }

    :global(.card-image-wrapper img) {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    :global(.card-footer) {
        margin-top: auto;
        border-top: 1px dashed #eee;
        padding-top: 12px;
    }

    :global(.price-label) {
        font-size: 0.7rem;
        color: var(--text-muted);
        display: block;
    }

    :global(.card-price) {
        font-weight: 800;
        color: var(--text-main);
        font-size: 1.2rem;
    }

    /* Skeleton Shimmer Effect */
    .card-skeleton {
        flex: 0 0 240px;
        height: 320px;
        background: #f6f7f8;
        background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
        background-repeat: no-repeat;
        background-size: 800px 100%;
        border-radius: var(--radius);
        animation: shimmer 1.5s infinite linear;
    }

    @keyframes shimmer {
        0% { background-position: -400px 0; }
        100% { background-position: 400px 0; }
    }
</style>