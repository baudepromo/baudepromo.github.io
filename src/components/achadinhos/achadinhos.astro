<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>

<script is:inline>
    // --- ESTADO GLOBAL ---
    let fullDataset = [];      // Todos os produtos carregados da API
    let currentResults = [];   // Produtos filtrados pela busca (ou todos se n√£o houver busca)
    let currentPage = 1;
    const PER_PAGE = 12;
    let fuseInstance = null;   // Inst√¢ncia do Fuse.js

    // --- CONFIGURA√á√ÉO DO FUSE.JS ---
    const fuseOptions = {
        isCaseSensitive: false,
        includeScore: true,
        shouldSort: true,
        threshold: 0.4, // 0.0 = correspond√™ncia exata, 1.0 = corresponde a tudo (0.4 √© bom padr√£o)
        keys: [
            { name: 'title', weight: 0.7 }, // T√≠tulo tem mais peso
            { name: 'description', weight: 0.3 } // Se tiver descri√ß√£o no JSON
        ]
    };

    // --- FUN√á√ïES UTILIT√ÅRIAS (Mantidas do original) ---
    function generateSlug(title) {
        return title.toString().toLowerCase().trim().normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '').replace(/[^\w\s-]/g, '')
            .replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function parsePriceToNumber(priceStr) {
        if (!priceStr) return 0;
        let clean = priceStr.toString().replace(/[^\d,]/g, '').replace(',', '.');
        return parseFloat(clean) || 0;
    }

    // --- ATUALIZA√á√ÉO DO SCHEMA (Mantida e Ajustada) ---
    function updateSchema(products) {
        const oldSchema = document.getElementById('dynamic-schema');
        if (oldSchema) oldSchema.remove();

        const schemaData = {
            "@context": "https://schema.org",
            "@type": "ItemList",
            "itemListElement": products.map((p, index) => {
                const priceNumber = parsePriceToNumber(p.currentPrice || p.price);
                const slug = generateSlug(p.title);
                return {
                    "@type": "ListItem",
                    "position": index + 1,
                    "item": {
                        "@type": "Product",
                        "name": p.title,
                        "image": p.img,
                        "offers": {
                            "@type": "Offer",
                            "priceCurrency": "BRL",
                            "price": priceNumber,
                            "url": window.location.origin + `/achadinhos/info?slug=${slug}`
                        }
                    }
                };
            })
        };

        const script = document.createElement('script');
        script.id = 'dynamic-schema';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(schemaData);
        document.head.appendChild(script);
    }

    // --- L√ìGICA DE RENDERIZA√á√ÉO (Com Pagina√ß√£o Local) ---
    function renderGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';

        // 1. Calcular Pagina√ß√£o Local
        const totalItems = currentResults.length;
        const totalPages = Math.ceil(totalItems / PER_PAGE);
        
        // Ajusta p√°gina se exceder o limite ap√≥s uma busca
        if (currentPage > totalPages) currentPage = 1;
        if (currentPage < 1) currentPage = 1;

        const start = (currentPage - 1) * PER_PAGE;
        const end = start + PER_PAGE;
        const productsToShow = currentResults.slice(start, end);

        // 2. Verificar Vazio
        if (totalItems === 0) {
            grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; padding: 50px; color: #666;">Nenhum produto encontrado. üîç</p>';
            updateControls(0);
            return;
        }

        updateSchema(productsToShow);

        // 3. Renderizar Cards
        productsToShow.forEach((p, index) => {
            let displayPrice = p.currentPrice || p.price || "0,00";
            let oldPriceHtml = p.oldPrice ? `<span class="old-price">R$ ${p.oldPrice}</span>` : '';
            const loadingAttr = index < 8 ? 'eager' : 'lazy';
            
            // Nota: Adicionei p.id e p.slug se existirem no JSON, sen√£o gera slug
            const slug = p.slug || generateSlug(p.title);
            const detailUrl = `/${slug}/a/${p.id}`;

            grid.insertAdjacentHTML('beforeend', `
                <a href="${detailUrl}" class="card" target="_blank">
                    <span class="badge">${p.badge || 'üî• OFERTA'}</span>
                    <div class="card-img-wrapper">
                        <img src="${p.img}" alt="${p.title}" loading="${loadingAttr}" width="300" height="300"
                            onerror="this.src='https://via.placeholder.com/300x200?text=Imagem+Indispon√≠vel'">
                    </div>
                    <div class="card-info">
                        <h3 class="card-title">${p.title}</h3>
                        <div class="price-box">
                            ${oldPriceHtml} <span class="price">R$ ${displayPrice}</span>
                        </div>
                        <span class="btn-view">VER OFERTA</span>
                    </div>
                </a>
            `);
        });

        updateControls(totalPages);
    }

    function updateControls(totalPages) {
        document.getElementById('page').innerText = totalPages === 0 ? 0 : currentPage;
        // Opcional: Mostrar "1 de 5"
        // document.getElementById('page').innerText = `${currentPage} / ${totalPages}`; 
        
        document.getElementById('prev').disabled = currentPage === 1 || totalPages === 0;
        document.getElementById('next').disabled = currentPage >= totalPages || totalPages === 0;
    }

    // --- L√ìGICA DO FUSE.JS (Busca) ---
    function handleSearch() {
        const query = document.getElementById('search').value;

        if (!query || query.trim() === '') {
            // Se busca vazia, mostra tudo (talvez embaralhado)
            currentResults = [...fullDataset]; 
            // shuffleArray(currentResults); // Descomente se quiser re-embaralhar ao limpar
        } else {
            // Executa Fuse.js
            const results = fuseInstance.search(query);
            // Fuse retorna [{item: {...}, refIndex: 0}, ...], precisamos extrair o 'item'
            currentResults = results.map(r => r.item);
        }

        currentPage = 1; // Reseta para primeira p√°gina da nova busca
        renderGrid();
    }

    // Debounce para n√£o travar a digita√ß√£o
    let debounceTimer;
    document.getElementById('search').addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(handleSearch, 300);
    });

    // --- CARREGAMENTO INICIAL (API) ---
    async function loadAllProducts() {
        const grid = document.getElementById('grid');
        try {
            // IMPORTANTE: Sua API precisa retornar TODOS os produtos, ou uma grande quantidade
            // Remova a pagina√ß√£o da URL se poss√≠vel, ou aumente o limite drasticamente.
            const url = `/api/busca.json?limit=1000`; 
            
            const res = await fetch(url);
            if (!res.ok) throw new Error("Erro na API");
            
            const result = await res.json();
            
            // Normaliza dados (assume que data √© o array)
            fullDataset = result.data || []; 
            
            // Embaralha inicial
            shuffleArray(fullDataset);
            
            // Define resultados iniciais
            currentResults = [...fullDataset];

            // Inicializa Fuse
            fuseInstance = new Fuse(fullDataset, fuseOptions);

            renderGrid();

        } catch (err) {
            console.error(err);
            grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">Erro ao carregar produtos.</p>';
        }
    }

    // --- EVENTOS DE PAGINA√á√ÉO ---
    document.getElementById('prev').onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            renderGrid();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    };

    document.getElementById('next').onclick = () => {
        const totalPages = Math.ceil(currentResults.length / PER_PAGE);
        if (currentPage < totalPages) {
            currentPage++;
            renderGrid();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    };

    // Iniciar
    loadAllProducts();
</script>