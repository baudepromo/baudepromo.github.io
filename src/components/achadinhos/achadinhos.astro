<script is:inline>
    let allProducts = [];
    let currentPage = 1;
    let totalPages = 1;
    const PER_PAGE = 12;

    // --- NOVA FUN√á√ÉO: Gera o slug a partir do t√≠tulo ---
    function generateSlug(title) {
        return title
            .toString()
            .toLowerCase()
            .trim()
            .normalize('NFD') // Decomp√µe caracteres acentuados
            .replace(/[\u0300-\u036f]/g, '') // Remove os acentos
            .replace(/[^\w\s-]/g, '') // Remove caracteres especiais
            .replace(/[\s_-]+/g, '-') // Substitui espa√ßos e underscores por h√≠fens
            .replace(/^-+|-+$/g, ''); // Remove h√≠fens extras no in√≠cio ou fim
    }

    // 1. Limpa o pre√ßo para formato num√©rico (Schema)
    function parsePriceToNumber(priceStr) {
        if (!priceStr) return 0;
        let clean = priceStr.toString().replace(/[^\d,]/g, '').replace(',', '.');
        return parseFloat(clean) || 0;
    }

    // 2. Atualiza o JSON-LD
    function updateSchema(products) {
        const oldSchema = document.getElementById('dynamic-schema');
        if (oldSchema) oldSchema.remove();

        const schemaData = {
            "@context": "https://schema.org",
            "@type": "ItemList",
            "itemListElement": products.map((p, index) => {
                const priceNumber = parsePriceToNumber(p.currentPrice || p.price);
                // USA O GERADOR DE SLUG AQUI
                const slug = generateSlug(p.title);
                const productUrl = window.location.origin + `/achadinhos/info?slug=${slug}`;

                return {
                    "@type": "ListItem",
                    "position": index + 1,
                    "item": {
                        "@type": "Product",
                        "name": p.title,
                        "image": p.img,
                        "description": `Oferta de: ${p.title}`,
                        "offers": {
                            "@type": "Offer",
                            "priceCurrency": "BRL",
                            "price": priceNumber,
                            "availability": "https://schema.org/InStock",
                            "url": productUrl
                        }
                    }
                };
            })
        };

        const script = document.createElement('script');
        script.id = 'dynamic-schema';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(schemaData);
        document.head.appendChild(script);
    }

    // --- L√ìGICA DE PESQUISA ---
    let debounceTimer;
    document.getElementById('search').addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            currentPage = 1;
            fetchProducts();
        }, 400);
    });

    // 3. FUN√á√ÉO RENDER PRINCIPAL
    function render(products) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        if (!products || products.length === 0) {
            grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; padding: 50px; color: #666;">Nenhum produto encontrado. üîç</p>';
            document.getElementById('page').innerText = "0";
            return;
        }

        updateSchema(products);

        products.forEach((p, index) => {
            let displayPrice = p.currentPrice || p.price || "0,00";
            let oldPriceHtml = p.oldPrice ? `<span class="old-price">R$ ${p.oldPrice}</span>` : '';
            
            const loadingAttr = index < 8 ? 'eager' : 'lazy';
            const fetchPriority = index < 2 ? 'fetchpriority="high"' : '';
            
            // USA O GERADOR DE SLUG AQUI TAMB√âM
            const detailUrl = `/${p.slug}/a/${p.id}`;

            grid.insertAdjacentHTML('beforeend', `
                <a href="${detailUrl}" class="card" target="_blank">
                    <span class="badge">${p.badge || 'üî• OFERTA'}</span>
                    <div class="card-img-wrapper">
                        <img 
                            src="${p.img}" 
                            alt="${p.title}" 
                            loading="${loadingAttr}"
                            ${fetchPriority}
                            onerror="this.src='https://via.placeholder.com/300x200?text=Imagem+Indispon√≠vel'"
                            decoding="async"
                            width="300"
                            height="300"
                        >
                    </div>
                    <div class="card-info">
                        <h3 class="card-title">${p.title}</h3>
                        <div class="price-box">
                            ${oldPriceHtml} <span class="price">R$ ${displayPrice}</span>
                        </div>
                        <span class="btn-view">VER OFERTA</span>
                    </div>
                </a>
            `);
        });

        document.getElementById('page').innerText = currentPage;
        document.getElementById('prev').disabled = currentPage === 1;
        document.getElementById('next').disabled = currentPage >= totalPages;
    }

    // --- CARREGAMENTO DO SERVIDOR ---
    async function fetchProducts() {
        const query = document.getElementById('search').value;
        const grid = document.getElementById('grid');

        try {
            const url = `/api/busca.json?q=${encodeURIComponent(query)}&page=${currentPage}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error("Erro ao buscar dados");
            
            const result = await res.json();
            
            allProducts = result.data;
            totalPages = result.meta.totalPages;
            
            render(allProducts);
        } catch (err) {
            console.error(err);
            grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">Erro ao conectar com o banco de dados.</p>';
        }
    }

    // Eventos de clique
    document.getElementById('prev').onclick = () => { 
        if(currentPage > 1) { 
            currentPage--; 
            fetchProducts(); 
            window.scrollTo(0,0); 
        } 
    };
    
    document.getElementById('next').onclick = () => { 
        if(currentPage < totalPages) { 
            currentPage++; 
            fetchProducts(); 
            window.scrollTo(0,0); 
        } 
    };

    fetchProducts();
</script>