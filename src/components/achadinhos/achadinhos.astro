<script is:inline>
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    const PER_PAGE = 12;

    // 1. Limpa o pre√ßo para formato num√©rico (Schema)
    function parsePriceToNumber(priceStr) {
        if (!priceStr) return 0;
        let clean = priceStr.toString().replace(/[^\d,]/g, '').replace(',', '.');
        return parseFloat(clean) || 0;
    }

    // 2. Atualiza o JSON-LD
    function updateSchema(products) {
        const oldSchema = document.getElementById('dynamic-schema');
        if (oldSchema) oldSchema.remove();

        const schemaData = {
            "@context": "https://schema.org",
            "@type": "ItemList",
            "itemListElement": products.map((p, index) => {
                const priceNumber = parsePriceToNumber(p.currentPrice || p.price);
                const productUrl = window.location.origin + `/achadinhos/info?slug=${p.slug || ''}`;

                return {
                    "@type": "ListItem",
                    "position": index + 1,
                    "item": {
                        "@type": "Product",
                        "name": p.title,
                        "image": p.img,
                        "description": `Oferta de: ${p.title}`,
                        "offers": {
                            "@type": "Offer",
                            "priceCurrency": "BRL",
                            "price": priceNumber,
                            "availability": "https://schema.org/InStock",
                            "url": productUrl
                        }
                    }
                };
            })
        };

        const script = document.createElement('script');
        script.id = 'dynamic-schema';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(schemaData);
        document.head.appendChild(script);
    }

    // --- L√ìGICA DE PESQUISA ---
    const normalizeText = (text) => 
        text ? text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";

    document.getElementById('search').addEventListener('input', (e) => {
        const termoBusca = normalizeText(e.target.value);
        const palavrasChave = termoBusca.split(' ').filter(p => p.length > 0);

        filteredProducts = allProducts.filter(produto => {
            const conteudoBusca = normalizeText(`${produto.title} ${produto.badge || ''}`);
            return palavrasChave.every(palavra => conteudoBusca.includes(palavra));
        });

        currentPage = 1; 
        render();
    });

    // 3. FUN√á√ÉO RENDER PRINCIPAL (Atualizada com Old Price)
    function render() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        if (filteredProducts.length === 0) {
            grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; padding: 50px; color: #666;">Nenhum produto encontrado. üîç</p>';
            document.getElementById('page').innerText = "0";
            return;
        }

        const start = (currentPage - 1) * PER_PAGE;
        const end = start + PER_PAGE;
        
        const visibleProducts = filteredProducts.slice(start, end);

        // Atualiza Schema apenas com vis√≠veis
        updateSchema(visibleProducts);

        visibleProducts.forEach((p, index) => {
            let displayPrice = p.currentPrice || p.price || "0,00";
            
            // --- NOVA L√ìGICA DO OLD PRICE ---
            // Se p.oldPrice existir, cria o span. Se n√£o, string vazia.
            let oldPriceHtml = p.oldPrice 
                ? `<span class="old-price">${p.oldPrice}</span>` 
                : '';

            const loadingAttr = index < 8 ? 'eager' : 'lazy';
            const fetchPriority = index < 2 ? 'fetchpriority="high"' : '';
            const productSlug = p.slug || p.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            const detailUrl = `/achadinhos/info?slug=${productSlug}`;

            grid.insertAdjacentHTML('beforeend', `
                <a href="${detailUrl}" class="card" target="_blank">
                    <span class="badge">${p.badge || 'üî• OFERTA'}</span>
                    <div class="card-img-wrapper">
                        <img 
                            src="${p.img}" 
                            alt="${p.title}" 
                            loading="${loadingAttr}"
                            ${fetchPriority}
                            onerror="this.src='https://via.placeholder.com/300x200?text=Imagem+Indispon√≠vel'"
                            decoding="async"
                            width="300"
                            height="300"
                        >
                    </div>
                    <div class="card-info">
                        <h3 class="card-title">${p.title}</h3>
                        
                        <div class="price-box">
                            ${oldPriceHtml} <span class="price">${displayPrice}</span>
                        </div>
                        
                        <span class="btn-view">VER OFERTA</span>
                    </div>
                </a>
            `);
        });

        document.getElementById('page').innerText = currentPage;
        document.getElementById('prev').disabled = currentPage === 1;
        document.getElementById('next').disabled = end >= filteredProducts.length;
    }

    // Carregamento Inicial
    async function loadProducts() {
        try {
            const res = await fetch('/data/achadinhos.json');
            if (!res.ok) throw new Error("Erro ao buscar JSON");
            const data = await res.json();
            
            allProducts = data.sort(() => Math.random() - 0.5);
            filteredProducts = [...allProducts];
            render();
        } catch (err) {
            console.error(err);
            document.getElementById('grid').innerHTML = '<p style="grid-column:1/-1; text-align:center;">Erro ao carregar ofertas.</p>';
        }
    }

    // Eventos de clique
    document.getElementById('prev').onclick = () => { if(currentPage > 1) { currentPage--; render(); window.scrollTo(0,0); } };
    document.getElementById('next').onclick = () => { if((currentPage * PER_PAGE) < filteredProducts.length) { currentPage++; render(); window.scrollTo(0,0); } };

    loadProducts();
</script>