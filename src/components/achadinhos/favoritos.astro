<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const firebaseConfig = {
        apiKey: "AIzaSyAltYkTpdrIShVv7wJXsszQqvOZXTC45Wg",
        authDomain: "baudepromocao-oficial.firebaseapp.com",
        projectId: "baudepromocao-oficial",
        storageBucket: "baudepromocao-oficial.firebasestorage.app",
        messagingSenderId: "743146859125",
        appId: "1:743146859125:web:6d1f5331e22b8ce981263c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const SUPABASE_URL = "https://xsdvzxggeuetqbmpvikw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzZHZ6eGdnZXVldHFibXB2aWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0Nzg1MTgsImV4cCI6MjA4NjA1NDUxOH0.PnP3_oo67NwR1_tLeHyDI3a9bBUi8-ZQuIFWMpOQs60";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
        const grid = document.getElementById("fav-grid");
        currentUser = user;

        if (user) {
            grid.innerHTML = `<div class="loading-container"><i class="fas fa-spinner fa-spin"></i><p>Carregando...</p></div>`;
            await loadUserFavorites(user.uid);
        } else {
            renderLoginState(grid);
        }
    });

    async function loadUserFavorites(uid) {
        const grid = document.getElementById("fav-grid");

        try {
            const userDocRef = doc(db, "wishlists2", uid);
            const userSnap = await getDoc(userDocRef);

            if (!userSnap.exists() || !userSnap.data().items || userSnap.data().items.length === 0) {
                renderEmptyState(grid);
                return;
            }

            // --- CORREÇÃO AQUI: FILTRAR APENAS IDs NUMÉRICOS ---
            // Isso remove textos como "Electrolux Kit..." que poluem o seu Firebase
            const rawItems = userSnap.data().items;
            const favoriteIds = rawItems
                .map(id => String(id))
                .filter(id => /^\d+$/.test(id)); // Só aceita se for apenas números

            if (favoriteIds.length === 0) {
                renderEmptyState(grid);
                return;
            }

            const { data: products, error } = await supabase
                .from('achadinhos')
                .select('*')
                .in('id', favoriteIds);

            if (error) throw error;
            renderGrid(grid, products);

        } catch (error) {
            console.error("Erro detalhado:", error);
            grid.innerHTML = `<div class="empty-state"><p>Erro ao carregar. Tente atualizar a página.</p></div>`;
        }
    }

    function renderGrid(grid, products) {
        if (!products || products.length === 0) {
            renderEmptyState(grid);
            return;
        }
        grid.innerHTML = "";
        products.forEach(p => {
            const title = p.title || p.nome_do_produto;
            const img = p.img || (Array.isArray(p.image) ? p.image[0] : p.image);
            grid.innerHTML += `
                <div class="card" id="card-${p.id}">
                    <img src="${img}" alt="${title}">
                    <div class="card-content">
                        <h3>${title}</h3>
                        <span class="price">R$ ${p.price}</span>
                        <a href="/${p.slug}/a/${p.id}" class="pill-btn btn-details">Ver Oferta</a>
                    </div>
                </div>`;
        });
    }

    function renderEmptyState(grid) {
        grid.innerHTML = `<div class="empty-state"><h2>Sua lista está vazia</h2><a href="/produtos" class="pill-btn btn-details">Ver Ofertas</a></div>`;
    }

    function renderLoginState(grid) {
        grid.innerHTML = `<div class="empty-state"><h2>Faça login para ver seus favoritos</h2></div>`;
    }
</script>