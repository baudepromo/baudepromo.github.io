<script type="module">
    // 1. IMPORTAR E INICIALIZAR SUPABASE & FUSE
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    import Fuse from 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.mjs'

    const supabaseUrl = 'https://xsdvzxggeuetqbmpvikw.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzZHZ6eGdnZXVldHFibXB2aWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0Nzg1MTgsImV4cCI6MjA4NjA1NDUxOH0.PnP3_oo67NwR1_tLeHyDI3a9bBUi8-ZQuIFWMpOQs60'
    const supabase = createClient(supabaseUrl, supabaseKey)

    // --- CONFIGURAÇÃO DA CATEGORIA ---
    const pageConfig = document.getElementById('page-config');
    // Se não tiver categoria definida, assume null (traz tudo ou trata conforme lógica)
    const currentCategory = pageConfig ? pageConfig.dataset.category : null;

    // --- VARIÁVEIS GLOBAIS ---
    let fuseInstance = null;
    let allProducts = [];
    let filteredProducts = [];
    
    let state = {
        itemsToShow: 12,
        search: "",
        minPrice: null,
        maxPrice: null,
        stores: [],
        sort: "relevance"
    };

    // Variáveis de controle de Log
    let lastLoggedTerm = "";
    let lastLogTime = 0;

    // --- FUNÇÕES UTILITÁRIAS ---

    function gerarSlug(texto) {
        if (!texto) return 'produto';
        return texto.toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .toLowerCase().trim().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-');
    }

    // Função Debounce (Evita lentidão ao digitar)
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    // --- LOGS NO SUPABASE ---
    async function logSearchToSupabase(term, count = 0) {
        if (!term || term.length < 3) return;
        const shortTerm = term.trim().substring(0, 30).toLowerCase();
        
        // Evita duplicatas e spam
        if (lastLoggedTerm === shortTerm) return;
        const now = Date.now();
        if (lastLogTime && (now - lastLogTime < 5000)) return;

        lastLoggedTerm = shortTerm;
        lastLogTime = now;

        // Adiciona contexto da categoria no log se quiser (opcional, aqui mantive a estrutura original)
        const { error } = await supabase
            .from('search_logs')
            .insert([{ term: shortTerm, results_count: count, category_context: currentCategory || 'geral' }]);

        if (error) console.error('Erro ao salvar log:', error);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // --- SELETORES DO DOM ---
        const productGrid = document.getElementById("product-grid");
        const searchInput = document.getElementById("search");
        const searchWrapper = document.getElementById("search-container-wrapper"); 
        const loadMoreBtn = document.getElementById("load-more");
        const minPriceInput = document.getElementById("min-price");
        const maxPriceInput = document.getElementById("max-price");
        const applyPriceBtn = document.getElementById("btn-apply-price");
        const storeCheckboxes = document.querySelectorAll('input[name="store"]');
        const sortSelect = document.getElementById("sort-select");
        const mobileFilterBtn = document.getElementById("mobile-filter-btn");
        const sidebar = document.getElementById("filter-sidebar");
        const closeSidebar = document.querySelector(".close-sidebar");
        
        // Criar elemento de Autocomplete se não existir
        let autocompleteList = document.getElementById("autocomplete-list");
        if (!autocompleteList && searchWrapper) {
            autocompleteList = document.createElement("div");
            autocompleteList.id = "autocomplete-list";
            autocompleteList.className = "autocomplete-items";
            searchWrapper.appendChild(autocompleteList);
        }

        // Recuperar busca da URL ao carregar
        const urlParams = new URLSearchParams(window.location.search);
        const searchFromUrl = urlParams.get('search');
        if (searchFromUrl) {
            state.search = searchFromUrl;
            if (searchInput) searchInput.value = searchFromUrl;
        }

        // --- LÓGICA PRINCIPAL DE FILTRO ---
        function applyFilters() {
            let tempProducts = [...allProducts];

            // 1. Busca (Fuse.js)
            if (state.search && state.search.trim().length > 0) {
                if (fuseInstance) {
                    const results = fuseInstance.search(state.search);
                    tempProducts = results.map(result => result.item);
                } else {
                    // Fallback simples
                    tempProducts = tempProducts.filter(p => 
                        p.title.toLowerCase().includes(state.search.toLowerCase())
                    );
                }
            }

            // 2. Preço
            if (state.minPrice) {
                tempProducts = tempProducts.filter(p => parseFloat(p.price) >= parseFloat(state.minPrice));
            }
            if (state.maxPrice) {
                tempProducts = tempProducts.filter(p => parseFloat(p.price) <= parseFloat(state.maxPrice));
            }

            // 3. Lojas
            if (state.stores.length > 0) {
                tempProducts = tempProducts.filter(p => {
                    const pStore = p.store ? p.store.toLowerCase().replace(/\s/g, '') : '';
                    return state.stores.includes(pStore);
                });
            }

            // 4. Ordenação
            if (state.sort === 'price_asc') {
                tempProducts.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
            } else if (state.sort === 'price_desc') {
                tempProducts.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
            }
            // Se for 'relevance' e tiver busca, o Fuse já entregou ordenado.

            filteredProducts = tempProducts;
            state.itemsToShow = 12; // Reseta paginação
            renderProducts();
        }

        // --- RENDERIZAÇÃO DO GRID ---
        function renderProducts() {
            if (!productGrid) return;
            productGrid.innerHTML = "";
            
            const visibleItems = filteredProducts.slice(0, state.itemsToShow);

            if (visibleItems.length === 0) {
                productGrid.innerHTML = `<div style='grid-column: 1/-1; text-align:center; padding: 40px; color: #666;'>Nenhum produto encontrado nesta categoria.</div>`;
                if(loadMoreBtn) loadMoreBtn.style.display = "none";
                return;
            }

            visibleItems.forEach(p => {
                const storeClass = p.store ? `badge-${p.store.toLowerCase().replace(/\s/g, '')}` : 'badge-default';
                const imgUrl = p.img || 'https://via.placeholder.com/300?text=Sem+Imagem';

                const card = document.createElement("article");
                card.className = "card";
                card.innerHTML = `
                    <div class="card-img-wrapper">
                        <span class="store-badge ${storeClass}">${p.store || 'Oferta'}</span>
                        <img src="${imgUrl}" alt="${p.title}" loading="lazy">
                    </div>
                    <div class="card-info">
                        <h3>${p.title}</h3>
                        <div class="price-row">
                            <span class="card-price">R$ ${parseFloat(p.price).toFixed(2).replace('.', ',')}</span>
                            <a href="${p.internalPath}" class="btn-ver">Ver</a>
                        </div>
                    </div>
                `;
                productGrid.appendChild(card);
            });

            if (loadMoreBtn) {
                loadMoreBtn.style.display = (filteredProducts.length > state.itemsToShow) ? "inline-block" : "none";
            }
        }

        // --- BUSCA DE DADOS COM FILTRO DE CATEGORIA ---
        async function initFetch() {
            try {
                // Prepara a query base
                let query = supabase.from('produtos').select('*');
                
                // APLICA O FILTRO DE CATEGORIA AQUI
                if (currentCategory) {
                    query = query.ilike('category', currentCategory);
                }

                let { data, error } = await query;
                if (error) throw error;

                allProducts = data.map(item => {
                    const titleField = item.title || item.nome_do_produto || "produto";
                    const slug = item.slug || gerarSlug(titleField);
                    return {
                        title: titleField, 
                        price: item.price,
                        img: item.img,
                        store: item.store,
                        link: item.link, 
                        internalPath: `/${slug}/p/${item.id}` 
                    };
                });

                // Configuração do Fuse.js (Agora operando apenas nos produtos desta categoria)
                const options = {
                    includeScore: true,
                    threshold: 0.4,
                    keys: [
                        { name: 'title', weight: 0.7 },
                        { name: 'store', weight: 0.3 }
                    ]
                };
                fuseInstance = new Fuse(allProducts, options);

                applyFilters(); 
            } catch (error) {
                console.error("Erro Supabase:", error);
                if(productGrid) productGrid.innerHTML = `<p style="text-align:center;">Erro ao carregar produtos: ${error.message}</p>`;
            }
        }

        // --- AUTOCOMPLETE & HISTÓRICO ---
        const MAX_RECENT_SEARCHES = 8;
        let currentFocus = -1;

        function getRecentSearches() {
            try {
                const stored = localStorage.getItem('bau_recent_searches');
                return stored ? JSON.parse(stored) : [];
            } catch (e) { return []; }
        }

        function saveRecentSearch(term) {
            if (!term || term.trim() === "") return;
            let searches = getRecentSearches();
            const cleanTerm = term.trim();
            searches = searches.filter(s => s.toLowerCase() !== cleanTerm.toLowerCase());
            searches.unshift(cleanTerm);
            if (searches.length > MAX_RECENT_SEARCHES) searches.pop();
            localStorage.setItem('bau_recent_searches', JSON.stringify(searches));
        }

        function clearHistory() {
            localStorage.removeItem('bau_recent_searches');
            if (searchInput) renderAutocomplete(searchInput.value);
        }

        function selectSearch(text) {
            if (searchInput) {
                searchInput.value = text;
                state.search = text;
                
                saveRecentSearch(text);
                
                // Atualiza URL
                const url = new URL(window.location);
                url.searchParams.set('search', text);
                window.history.replaceState({}, '', url);
                
                applyFilters();
                
                const count = filteredProducts.length; 
                logSearchToSupabase(text, count);

                closeAutocomplete();
                searchInput.blur();
            }
        }

        function renderAutocomplete(inputValue) {
            if (!autocompleteList) return;
            autocompleteList.innerHTML = '';
            currentFocus = -1;
            
            const term = inputValue ? inputValue.toLowerCase().trim() : "";
            let hasContent = false;

            // CASO 1: Input Vazio -> Mostrar Histórico
            if (!term) {
                const recent = getRecentSearches();
                if (recent.length > 0) {
                    const header = document.createElement('div');
                    header.className = 'autocomplete-header';
                    header.innerHTML = `Buscas Recentes <span class="clear-history-btn" style="float:right; cursor:pointer; font-size:12px; color:red;">Limpar</span>`;
                    
                    header.querySelector('.clear-history-btn').addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        clearHistory();
                    });
                    autocompleteList.appendChild(header);

                    recent.forEach(text => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item';
                        item.innerHTML = `
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            <span>${text}</span>
                        `;
                        item.addEventListener('click', () => selectSearch(text));
                        autocompleteList.appendChild(item);
                    });
                    hasContent = true;
                }
            } 
            // CASO 2: Tem texto -> Sugestões do Fuse (Dentro da Categoria)
            else {
                let matches = [];
                if (fuseInstance) {
                    const results = fuseInstance.search(term, { limit: 8 });
                    matches = results.map(r => r.item);
                } else {
                    matches = allProducts.filter(p => p.title.toLowerCase().includes(term)).slice(0, 8);
                }

                if (matches.length > 0) {
                    matches.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item';
                        const regex = new RegExp(`(${term})`, 'gi');
                        const highlightTitle = p.title.replace(regex, '<b>$1</b>');

                        item.innerHTML = `
                             <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${highlightTitle}</span>
                        `;
                        item.addEventListener('click', () => selectSearch(p.title));
                        autocompleteList.appendChild(item);
                    });
                    hasContent = true;
                } else {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.innerHTML = `<span style="color:#999; font-style:italic; padding: 10px;">Nenhum resultado na categoria "${currentCategory || 'Geral'}"</span>`;
                    autocompleteList.appendChild(item);
                    hasContent = true;
                }
            }

            if (hasContent) {
                autocompleteList.style.display = 'block';
                if(searchWrapper) searchWrapper.classList.add('active');
            } else {
                closeAutocomplete();
            }
        }

        function closeAutocomplete() {
            if(autocompleteList) autocompleteList.style.display = 'none';
            if(searchWrapper) searchWrapper.classList.remove('active');
        }

        function addActive(items) {
            if (!items) return false;
            removeActive(items);
            if (currentFocus >= items.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (items.length - 1);
            items[currentFocus].classList.add("selected");
            items[currentFocus].scrollIntoView({ block: 'nearest' });
        }

        function removeActive(items) {
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove("selected");
            }
        }

        // --- LISTENERS DE EVENTOS ---

        // 1. Input de Busca
        if (searchInput) {
            searchInput.setAttribute("autocomplete", "off");

            searchInput.addEventListener("input", (e) => {
                const value = e.target.value;
                state.search = value;
                // Debounce para o grid, instantâneo para autocomplete
                debounce(() => applyFilters(), 300)(); 
                renderAutocomplete(value);
            });

            searchInput.addEventListener("focus", () => renderAutocomplete(searchInput.value));
            searchInput.addEventListener("click", () => renderAutocomplete(searchInput.value));

            searchInput.addEventListener("keydown", (e) => {
                let items = autocompleteList ? autocompleteList.getElementsByClassName("autocomplete-item") : [];
                if (e.key === "ArrowDown") {
                    currentFocus++;
                    addActive(items);
                } else if (e.key === "ArrowUp") {
                    currentFocus--;
                    addActive(items);
                } else if (e.key === "Enter") {
                    e.preventDefault();
                    if (currentFocus > -1 && items && items[currentFocus]) {
                        items[currentFocus].click();
                    } else {
                        selectSearch(searchInput.value);
                    }
                } else if (e.key === "Escape") {
                    closeAutocomplete();
                }
            });
        }

        // 2. Fechar ao clicar fora
        document.addEventListener("click", (e) => {
            if (searchWrapper && !searchWrapper.contains(e.target)) {
                closeAutocomplete();
            }
        });

        // 3. Botão Carregar Mais
        if(loadMoreBtn) {
            loadMoreBtn.addEventListener("click", () => {
                state.itemsToShow += 12;
                renderProducts();
            });
        }

        // 4. Filtro de Preço
        if(applyPriceBtn) {
            applyPriceBtn.addEventListener("click", () => {
                state.minPrice = minPriceInput.value;
                state.maxPrice = maxPriceInput.value;
                applyFilters();
                if(window.innerWidth <= 900 && sidebar) sidebar.classList.remove("active");
            });
        }

        // 5. Filtro de Loja
        storeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener("change", (e) => {
                const val = e.target.value.toLowerCase().replace(/\s/g, '');
                if (e.target.checked) {
                    state.stores.push(val);
                } else {
                    state.stores = state.stores.filter(s => s !== val);
                }
                applyFilters();
            });
        });

        // 6. Ordenação
        if(sortSelect) {
            sortSelect.addEventListener("change", (e) => {
                state.sort = e.target.value;
                applyFilters();
            });
        }

        // 7. Mobile Sidebar
        if(mobileFilterBtn && sidebar) {
            mobileFilterBtn.addEventListener("click", () => sidebar.classList.add("active"));
        }
        if(closeSidebar && sidebar) {
            closeSidebar.addEventListener("click", () => sidebar.classList.remove("active"));
        }

        // --- INICIALIZAR ---
        initFetch();
    });
</script>