<script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAltYkTpdrIShVv7wJXsszQqvOZXTC45Wg",
        authDomain: "baudepromocao-oficial.firebaseapp.com",
        projectId: "baudepromocao-oficial",
        storageBucket: "baudepromocao-oficial.firebasestorage.app",
        messagingSenderId: "743146859125",
        appId: "1:743146859125:web:6d1f5331e22b8ce981263c"
    };

    const app = getApps().length > 0 ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- CONFIGURAÇÃO DAS FONTES DE DADOS ---
    // Liste aqui todos os seus arquivos JSON de produtos
    const DATA_SOURCES = [
        '/data/categorias/moda.json',
        '/data/categorias/eletronicos.json',
        '/data/categorias/casa.json',
        '/data/categorias/cozinha.json',
        '/data/categorias/beleza.json',
        '/data/categorias/fitness.json'
    ];

    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
        const grid = document.getElementById("fav-grid");
        currentUser = user;

        if (user) {
            grid.innerHTML = `
                <div class="loading-container">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
                    <p>Buscando seus favoritos...</p>
                </div>`;
            await loadUserFavorites(user.uid);
        } else {
            renderLoginState(grid);
        }
    });

    async function loadUserFavorites(uid) {
        const grid = document.getElementById("fav-grid");

        try {
            // 1. Buscar Lista de IDs no Firestore
            const userDocRef = doc(db, "wishlists", uid);
            const userSnap = await getDoc(userDocRef);

            if (!userSnap.exists() || !userSnap.data().items || userSnap.data().items.length === 0) {
                renderEmptyState(grid);
                return;
            }

            const favoriteIds = userSnap.data().items.map(id => String(id));

            // 2. Buscar TODOS os produtos (de todas as categorias configuradas)
            // Usamos Promise.all para carregar todos os JSONs ao mesmo tempo (mais rápido)
            const fetchPromises = DATA_SOURCES.map(url => 
                fetch(url + '?' + new Date().getTime()).then(res => res.json()).catch(() => [])
            );
            
            const results = await Promise.all(fetchPromises);
            // Junta todos os produtos em um único array (flat)
            const allProducts = results.flat();

            // 3. Filtrar: Encontrar os produtos cujos IDs estão na lista do usuário
            const myFavorites = allProducts.filter(p => favoriteIds.includes(String(p.id)));

            if (myFavorites.length === 0) {
                // Caso tenha IDs salvos, mas os produtos não existam mais nos JSONs
                renderEmptyState(grid);
                return;
            }

            // 4. Renderizar
            renderGrid(grid, myFavorites);

        } catch (error) {
            console.error("Erro:", error);
            grid.innerHTML = `
                <div class="empty-state">
                    <i class="fa-solid fa-triangle-exclamation empty-icon" style="color: #ff9000;"></i>
                    <p>Erro ao carregar favoritos.</p>
                </div>`;
        }
    }

    function renderGrid(grid, products) {
        grid.innerHTML = "";
        products.forEach(p => {
            const slug = p.slug || p.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            
            grid.innerHTML += `
                <div class="card" id="card-${p.id}">
                    <button class="btn-remove-fav" onclick="window.removeFavorite('${p.id}')" title="Remover dos favoritos">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    <img src="${p.img}" alt="${p.title}" loading="lazy">
                    <div class="card-content">
                        <h3>${p.title}</h3>
                        <span class="price">R$ ${p.price}</span>
                        <a href="/produtos/categorias/${p.categoria}/info/?slug=${slug}" class="pill-btn btn-details">
                            Ver Oferta <i class="fa-solid fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
            `;
        });
    }

    // Função global para ser acessada pelo onclick do HTML
    window.removeFavorite = async (productId) => {
        if (!currentUser) return;

        const card = document.getElementById(`card-${productId}`);
        const confirmBtn = confirm("Deseja remover este item dos favoritos?");
        
        if (confirmBtn) {
            try {
                // Remove visualmente primeiro (UX rápida)
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';

                // Remove do Firestore
                const userDocRef = doc(db, "wishlists", currentUser.uid);
                await updateDoc(userDocRef, {
                    items: arrayRemove(productId), // Se o ID for número no JSON, use: arrayRemove(Number(productId))
                    items: arrayRemove(Number(productId)) // Garante remoção se for numero ou string (previne erros de tipo)
                });

                // Remove do DOM
                card.remove();

                // Verifica se sobrou algo
                const grid = document.getElementById("fav-grid");
                if (grid.children.length === 0) {
                    renderEmptyState(grid);
                }

            } catch (error) {
                console.error("Erro ao remover:", error);
                alert("Erro ao remover. Tente novamente.");
                card.style.opacity = '1';
                card.style.pointerEvents = 'all';
            }
        }
    };

    function renderEmptyState(grid) {
        grid.innerHTML = `
            <div class="empty-state">
                <i class="fa-regular fa-heart empty-icon"></i>
                <h2>Sua lista está vazia</h2>
                <p>Favorite alguns produtos e eles aparecerão aqui!</p>
                <a href="/produtos" class="pill-btn btn-cta">Ver Ofertas</a>
            </div>
        `;
    }

    function renderLoginState(grid) {
        grid.innerHTML = `
            <div class="empty-state">
                <i class="fa-solid fa-lock empty-icon" style="color: #ff4b4b;"></i>
                <h2>Acesso Restrito</h2>
                <p>Faça login para ver sua lista de desejos.</p>
                <a href="#" onclick="window.openAuthModal(); return false;" class="pill-btn btn-cta">Fazer Login</a>
            </div>
        `;
    }
</script>