<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. CONFIGURAÇÃO (Não altere)
    const firebaseConfig = {
        apiKey: "AIzaSyAltYkTpdrIShVv7wJXsszQqvOZXTC45Wg",
        authDomain: "baudepromocao-oficial.firebaseapp.com",
        projectId: "baudepromocao-oficial",
        storageBucket: "baudepromocao-oficial.firebasestorage.app",
        messagingSenderId: "743146859125",
        appId: "1:743146859125:web:6d1f5331e22b8ce981263c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // 2. ÍCONES
    const SVGS = {
        heartOutline: `<svg class="icon-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`,
        heartFilled:  `<svg class="icon-filled" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`,
        bellOutline:  `<svg class="icon-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`,
        bellFilled:   `<svg class="icon-filled" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`,
        share:        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>`,
        shop:         `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-8 2a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"></path></svg>`,
        truck:        `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>`,
        shield:       `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`,
        card:         `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>`,
        check:        `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
        arrowOut:     `<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left:8px"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>`
    };

    // 3. TOAST (Notificação)
    window.showToast = (msg) => {
        const toast = document.getElementById('toast-box');
        if (!toast) {
            alert(msg); // Fallback se não tiver toast
            return;
        }
        const infoIcon = `<svg style="display:inline-block; vertical-align:middle; margin-right:5px" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;
        toast.innerHTML = `${infoIcon} ${msg}`;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    };

    // 4. FUNÇÕES GLOBAIS (DEFINIDAS AQUI PARA EVITAR O ERRO)
    
    // Função Auxiliar (Interna)
    async function toggleCollection(collectionName, productId, elementId, activeClass, successMsg, removedMsg) {
        if (!auth.currentUser) {
            const modal = document.getElementById('login-modal');
            if(modal) modal.style.display = 'flex';
            else alert("Faça login para continuar!");
            return;
        }

        const btn = document.getElementById(elementId);
        if(!btn) return;

        const userRef = doc(db, collectionName, auth.currentUser.uid);
        const wasActive = btn.classList.contains(activeClass);

        btn.classList.toggle(activeClass); // Troca cor instantaneamente

        try {
            const snap = await getDoc(userRef);
            if (!wasActive) {
                // Adiciona
                if (!snap.exists()) {
                    await setDoc(userRef, { email: auth.currentUser.email, items: [String(productId)], updatedAt: new Date() });
                } else {
                    await updateDoc(userRef, { items: arrayUnion(String(productId)) });
                }
                window.showToast(successMsg);
            } else {
                // Remove
                await updateDoc(userRef, { items: arrayRemove(String(productId)) });
                window.showToast(removedMsg);
            }
        } catch (e) {
            console.error(`Erro:`, e);
            btn.classList.toggle(activeClass); // Desfaz em caso de erro
            window.showToast("Erro ao salvar.");
        }
    }

    // --- AQUI ESTÁ A CORREÇÃO: "window." ---
    window.toggleWishlist = function(productId, elementId) {
        toggleCollection('wishlists', productId, elementId, 'active', 'Salvo nos favoritos!', 'Removido dos favoritos.');
    };

    window.toggleAlert = function(productId, elementId) {
        toggleCollection('alerts', productId, elementId, 'active', 'Alerta ativado!', 'Alerta removido.');
    };

    window.shareLink = async function(title, url) {
        console.log("Tentando compartilhar:", title, url);
        if (navigator.share) {
            try {
                await navigator.share({
                    title: title,
                    text: `Olha essa oferta: ${title}`,
                    url: url
                });
            } catch (err) {
                console.log('Compartilhamento cancelado');
            }
        } else {
            try {
                await navigator.clipboard.writeText(url);
                window.showToast('Link copiado!');
            } catch (err) {
                prompt("Copie o link:", url);
            }
        }
    };

    // 5. CARREGAMENTO DO PRODUTO
    async function loadProductDetails() {
        const params = new URLSearchParams(window.location.search);
        const slug = params.get('slug'); 
        const fallbackId = params.get('id');
        const contentArea = document.getElementById("content-area");

        if (!slug && !fallbackId) return;

        try {
            const res = await fetch('/data/produtos.json');
            let products = await res.json();
            
            // Corrige Slugs
            products = products.map((p, index) => ({
                ...p,
                id: p.id !== undefined ? p.id : index,
                slug: p.slug || p.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '')
            }));

            let product;
            if (slug) product = products.find(p => p.slug === slug);
            else if (fallbackId) product = products.find(p => String(p.id).trim() === fallbackId.trim());

            if (!product) {
                contentArea.innerHTML = `<h2>Oferta não encontrada!</h2>`;
                return;
            }

            const metaOgImage = document.querySelector('meta[property="og:image"]');
    const metaTwitterImage = document.querySelector('meta[name="twitter:image"]');
    
    if (metaOgImage) metaOgImage.setAttribute('content', product.img);
    if (metaTwitterImage) metaTwitterImage.setAttribute('content', product.img);

            // Define IDs seguros
            const safeId = String(product.id).replace(/[^a-zA-Z0-9]/g, '');
            const heartId = "heart_" + safeId;
            const alertId = "alert_" + safeId;
            
            // TRUQUE PARA O SHARE NÃO QUEBRAR COM ASPAS SIMPLES
            // Se o título for: TV 50' Samsung -> vira -> TV 50\' Samsung
            const safeTitle = product.title.replace(/'/g, "\\'"); 
            const shareUrl = window.location.origin + window.location.pathname + "?slug=" + product.slug;

            document.title = product.title;

            contentArea.innerHTML = `
                <div class="img-side">
                    <div class="floating-actions">
                        <button id="${heartId}" class="icon-btn heart-btn" onclick="window.toggleWishlist('${product.id}', '${heartId}')">
                            ${SVGS.heartOutline}${SVGS.heartFilled}
                        </button>
                        <button id="${alertId}" class="icon-btn alert-btn" onclick="window.toggleAlert('${product.id}', '${alertId}')">
                            ${SVGS.bellOutline}${SVGS.bellFilled}
                        </button>
                        <button class="icon-btn" onclick="window.shareLink('${safeTitle}', '${shareUrl}')">
                          ${SVGS.share}
                        </button>
                    </div>
                    <img src="${product.img}" alt="${product.title}" loading="lazy">
                </div>
                <div class="info-side">
                    <span class="store-tag">${SVGS.shop} ${product.store}</span>
                    <h1>${product.title}</h1>
                    <div class="price-wrapper">
                        <p class="price-label">Melhor preço encontrado:</p>
                        <div class="price-tag"><span>R$</span> ${product.price}</div>
                    </div>
                    <div class="benefits-grid">
                        <div class="benefit-item">${SVGS.truck} Frete Grátis</div>
                        <div class="benefit-item">${SVGS.shield} Compra Segura</div>
                        <div class="benefit-item">${SVGS.card} Parcelamento</div>
                        <div class="benefit-item">${SVGS.check} Original</div>
                    </div>
                    <a href="${product.link}" target="_blank" class="cta-button">
                        Ir para a Loja ${SVGS.arrowOut}
                    </a>
                </div>
            `;
            
            // Checa status (Logado)
            if (auth.currentUser) {
                checkStatus("wishlists", product.id, heartId);
                checkStatus("alerts", product.id, alertId);
            }

        } catch (e) {
            console.error("Erro Crítico:", e);
            contentArea.innerHTML = "<h2>Erro ao carregar oferta.</h2>";
        }
    }

    async function checkStatus(collectionName, productId, elementId) {
        if(!auth.currentUser) return;
        try {
            const snap = await getDoc(doc(db, collectionName, auth.currentUser.uid));
            if (snap.exists() && snap.data().items?.includes(String(productId))) {
                document.getElementById(elementId)?.classList.add('active');
            }
        } catch(e) { console.log(e); }
    }

    // LOGIN
    const btnLogin = document.getElementById('btn-google-login');
    if(btnLogin) {
        btnLogin.addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                document.getElementById('login-modal').style.display = 'none';
                window.showToast(`Bem-vindo!`);
                loadProductDetails(); 
            } catch (error) {
                console.error(error);
            }
        });
    }

    // Monitora Login
    onAuthStateChanged(auth, (user) => { 
        const content = document.getElementById("content-area");
        // Se ainda não carregou ou se precisa atualizar icones
        if(content) loadProductDetails(); 
    });

    // Inicia
    loadProductDetails();
    console.log("Script Carregado com Sucesso!");
</script>