<script is:inline>
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    const PER_PAGE = 12;

    async function loadProducts() {
        try {
            const res = await fetch('/data/achadinhos.json');
            if (!res.ok) throw new Error("Erro ao buscar JSON");
            const data = await res.json();
            
            // Mantendo sua l√≥gica de embaralhar
            allProducts = data.sort(() => Math.random() - 0.5);
            filteredProducts = [...allProducts];
            render();
        } catch (err) {
            document.getElementById('grid').innerHTML = '<p style="grid-column:1/-1; text-align:center;">Erro ao carregar ofertas.</p>';
        }
    }

    // --- L√ìGICA DE PESQUISA ---
    const normalizeText = (text) => 
        text ? text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";

    document.getElementById('search').addEventListener('input', (e) => {
        const termoBusca = normalizeText(e.target.value);
        const palavrasChave = termoBusca.split(' ').filter(p => p.length > 0);

        filteredProducts = allProducts.filter(produto => {
            // Texto onde vamos procurar (T√≠tulo + Badge)
            const conteudoBusca = normalizeText(`${produto.title} ${produto.badge || ''}`);
            
            // Verifica se TODAS as palavras digitadas est√£o no conte√∫do do produto
            return palavrasChave.every(palavra => conteudoBusca.includes(palavra));
        });

        currentPage = 1; 
        render();
    });

    function render() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        // Se n√£o houver resultados
        if (filteredProducts.length === 0) {
            grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; padding: 50px; color: #666;">Nenhum produto encontrado. üîç</p>';
            document.getElementById('page').innerText = "0";
            return;
        }

        const start = (currentPage - 1) * PER_PAGE;
        const end = start + PER_PAGE;

        // Adicionei o 'index' aqui para sabermos a posi√ß√£o do item
        filteredProducts.slice(start, end).forEach((p, index) => {
            let displayPrice = p.currentPrice || p.price || "0,00";
            
            // --- L√ìGICA DO LAZY LOADING ---
            // Se o √≠ndice for menor que 6 (0 a 5), carrega imediato (eager).
            // Caso contr√°rio, usa o lazy load.
            const loadingAttr = index < 8 ? 'eager' : 'lazy';
            
            // Opcional: Adicionar fetchpriority="high" nos 2 primeiros para prioridade m√°xima
            const fetchPriority = index < 2 ? 'fetchpriority="high"' : '';

            grid.insertAdjacentHTML('beforeend', `
                <a href="${p.link}" class="card" target="_blank">
                    <span class="badge">${p.badge || 'üî• OFERTA'}</span>
                    <div class="card-img-wrapper">
                        <img 
                            src="${p.image}" 
                            alt="${p.img}"
                            loading="${loadingAttr}"
                            ${fetchPriority}
                            onerror="this.src='https://via.placeholder.com/300x200?text=Imagem+Indispon√≠vel'"
                            decoding="async"
                            width="300"
                            height="300"
                        >
                    </div>
                    <div class="card-info">
                        <h3 class="card-title">${p.title}</h3>
                        <div class="price-box">
                            <span class="price">${displayPrice}</span>
                        </div>
                        <span class="btn-view">VER OFERTA</span>
                    </div>
                </a>
            `);
        });

        // Atualiza pagina√ß√£o
        document.getElementById('page').innerText = currentPage;
        document.getElementById('prev').disabled = currentPage === 1;
        document.getElementById('next').disabled = end >= filteredProducts.length;
    }

    // Eventos de clique dos bot√µes
    document.getElementById('prev').onclick = () => { if(currentPage > 1) { currentPage--; render(); window.scrollTo(0,0); } };
    document.getElementById('next').onclick = () => { if((currentPage * PER_PAGE) < filteredProducts.length) { currentPage++; render(); window.scrollTo(0,0); } };

    loadProducts();
</script>