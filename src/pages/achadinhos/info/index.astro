---
import Layout from "../../../layouts/MainLayout.astro";
import Global from '../../../components/global.astro';
import Info from '../../../components/achadinhos/info.astro';
import Seo from "../../../../public/lib/seo/metadada.astro";
import { SITE_CONFIG } from "public/lib/seo/constants";
import { getAbsoluteUrl, getPageTitle } from 'public/lib/seo/utils'; 
interface Produto {
  id: string | number;
  img: string;
}

const {
  title
} = Astro.props;

const finalTitle = getPageTitle(title);

const productId = Astro.url.searchParams.get('id');

let seoData = {
  title: "O Seu Próximo Essencial Está Aqui | Baú de Promoção",
  description: "Bem-vindo ao Baú de Promoções...",
  image: "https://baudepromocao.vercel.app/og/ogmain.png"
};

if (productId) {
  try {
    const response = await fetch(`https://baudepromocao.vercel.app/data/achadinhos.json`);
    
    if (response.ok) {
      // 2. Diga ao TypeScript que isso é um Array de Produtos
      const allProducts: Produto[] = await response.json();
      
      // Agora o TS sabe que 'item' é um 'Produto', e o erro some!
      const product = allProducts.find((item) => item.id == productId);

      if (product) {
        seoData.image = product.img || seoData.image; 
        seoData.title = title ? `${title} | Baú` : seoData.title;
      }
    }
  } catch (error) {
    console.error("Erro ao buscar dados:", error);
  }
}
---

<Seo 
  slot="seo"
  ogTitle={finalTitle}
  type="article" 
  title={finalTitle} 
  description={seoData.title}
  image={seoData.image}
/>

<Layout>
    <link rel="stylesheet" href="/styles/pages/produtos.css">
    
    <section class="hero-section" style="position: relative;">
        <div class="faq-wrapper">
            <a href="/achadinhos" class="btn-back">
              <svg class="icon-back" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
              </svg>
              Voltar
            </a>
            
            <h1>{productId ? 'Oferta Encontrada' : 'Melhores Produtos do Baú'}</h1>
            <p>Apenas produtos selecionados</p>
        </div>
    </section> 

    <div class="main-container">
        <div id="content-area" class="detail-card">
            <div class="loading-container">
                <p style="margin-top: 20px; color: var(--text-muted); font-weight: 600;">Carregando melhor oferta...</p>
            </div>
        </div>
    </div>

    <div id="toast-box" class="toast"></div>

    <div id="login-modal" class="modal-overlay">
       <div style="background: white; padding: 40px; border-radius: 25px; text-align: center; max-width: 380px; width: 90%; box-shadow: 0 25px 50px rgba(0,0,0,0.2);">
           <button onclick="document.getElementById('login-modal').style.display='none'" style="background: transparent; border: none; color: #666; margin-top: 20px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                Cancelar
            </button>
       </div>
    </div>
    
    <Global></Global>
    <Info></Info>
</Layout>