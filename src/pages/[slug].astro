---
export const prerender = false;

import { createClient } from '@supabase/supabase-js';
import Layout from "../layouts/MainLayout.astro";
import Global from '../components/global.astro';
import Seo from "../lib/seo/metadada.astro";

const { slug } = Astro.params;

// 1. EXTRA√á√ÉO DO ID (Melhorada para aceitar h√≠fen ou ponto)
const idFromUrl = slug ? slug.split(/[-.]/).pop() : null;

const supabaseUrl = 'https://xsdvzxggeuetqbmpvikw.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzZHZ6eGdnZXVldHFibXB2aWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0Nzg1MTgsImV4cCI6MjA4NjA1NDUxOH0.PnP3_oo67NwR1_tLeHyDI3a9bBUi8-ZQuIFWMpOQs60'
const supabase = createClient(supabaseUrl, supabaseKey)

const { data: product, error } = await supabase
  .from('produtos')
  .select('*')
  .eq('id', idFromUrl)
  .single();

if (error || !product) {
     return Astro.redirect('/404');
}

const p = {
    id: String(product.id),
    title: product.title || product.nome_do_produto,
    price: product.price,
    oldPrice: product.oldPrice, 
    img: product.img || (Array.isArray(product.image) ? product.image[0] : product.image),
    store: product.store,
    link: product.link,
};

const safeTitle = p.title.replace(/"/g, '&quot;');

const SVGS = {
    shop: `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-8 2a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"></path></svg>`,
    heartOutline: `<svg class="icon-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`,
    heartFilled: `<svg class="icon-filled" viewBox="0 0 24 24" fill="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`,
    bellOutline: `<svg class="icon-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`,
    bellFilled: `<svg class="icon-filled" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`,
    share: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>`,
    arrowOut: `<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>`
};
---
<Seo title={p.title} image={p.img}></Seo>

<Layout title={p.title}>
    <link rel="stylesheet" href="/styles/pages/produtos.css">
    
    <div 
        id="product-metadata" 
        style="display: none;" 
        data-id={p.id} 
        data-title={safeTitle}
    ></div>

    <div class="main-container">
        <div class="detail-card">
            <div class="img-side">
                <div class="floating-actions">
                    <button id="btn-wishlist" class="icon-btn js-wishlist-btn" title="Favoritar">
                        <Fragment set:html={SVGS.heartOutline + SVGS.heartFilled} />
                    </button>
                    <button id="btn-alert" class="icon-btn js-alert-btn" title="Ativar Alerta">
                        <Fragment set:html={SVGS.bellOutline + SVGS.bellFilled} />
                    </button>
                    <button id="btn-share" class="icon-btn js-share-btn" title="Compartilhar">
                        <Fragment set:html={SVGS.share} />
                    </button>
                </div>
                <img src={p.img} alt={p.title} />
            </div>

            <div class="info-side">
                <span class="store-tag"><Fragment set:html={SVGS.shop} /> {p.store}</span>
                <h1>{p.title}</h1>
                <div class="price-wrapper">
                    {p.oldPrice && <span class="old-price">R$ {p.oldPrice}</span>}
                    <div class="price-tag"><span>R$</span> {p.price}</div>
                </div>
                <a href={p.link} target="_blank" class="cta-button">
                    Ir para a Loja <Fragment set:html={SVGS.arrowOut} />
                </a>
            </div>
        </div>
    </div>

    <Global />
</Layout>

<script type="module">
    // Importa√ß√µes ajustadas (verifique se o caminho do seu firebase.js est√° correto)
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove } from "firebase/firestore";
    import { getAuth, onAuthStateChanged } from "firebase/auth";
    import { app } from '../../public/lib/firebase/firebase'; // Ajuste o caminho se necess√°rio

    const db = getFirestore(app);
    const auth = getAuth(app);

    const metaData = document.getElementById('product-metadata');
    const productId = metaData?.dataset.id;
    const productTitle = metaData?.dataset.title;

    const heartBtn = document.getElementById('btn-wishlist');
    const alertBtn = document.getElementById('btn-alert');
    const shareBtn = document.getElementById('btn-share');

    function showToast(msg) {
        const toast = document.getElementById('toast-box');
        if (toast) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        } else {
            alert(msg);
        }
    }

    async function toggleCollection(collectionName, btnElement, successMsg, removedMsg) {
        const user = auth.currentUser;
        if (!user) {
            const modal = document.getElementById('login-modal');
            modal ? modal.style.display = 'flex' : alert("Fa√ßa login para salvar produtos.");
            return;
        }

        const isAdding = !btnElement.classList.contains('active');
        btnElement.classList.toggle('active'); // UI Otimista

        const userRef = doc(db, collectionName, user.uid);

        try {
            const snap = await getDoc(userRef);
            if (isAdding) {
                if (!snap.exists()) {
                    await setDoc(userRef, { items: [productId], updatedAt: new Date() });
                } else {
                    await updateDoc(userRef, { items: arrayUnion(productId) });
                }
                showToast(successMsg);
            } else {
                await updateDoc(userRef, { items: arrayRemove(productId) });
                showToast(removedMsg);
            }
        } catch (e) {
            console.error(e);
            btnElement.classList.toggle('active'); // Reverte em erro
            showToast("Erro ao salvar. Tente novamente.");
        }
    }

    // Listeners
    heartBtn?.addEventListener('click', () => 
        toggleCollection('wishlists', heartBtn, '‚ù§Ô∏è Salvo nos favoritos!', 'Removido dos favoritos.'));

    alertBtn?.addEventListener('click', () => 
        toggleCollection('alerts', alertBtn, 'üîî Alerta de pre√ßo ativado!', 'Alerta desativado.'));

    shareBtn?.addEventListener('click', async () => {
        const url = window.location.href;
        if (navigator.share) {
            try {
                await navigator.share({ title: productTitle, url });
            } catch (err) {}
        } else {
            await navigator.clipboard.writeText(url);
            showToast('üîó Link copiado!');
        }
    });

    // Verificar estado inicial
    onAuthStateChanged(auth, async (user) => {
        if (user && productId) {
            // Favoritos
            getDoc(doc(db, "wishlists", user.uid)).then(snap => {
                if (snap.exists() && snap.data().items?.includes(productId)) {
                    heartBtn?.classList.add('active');
                }
            });
            // Alertas
            getDoc(doc(db, "alerts", user.uid)).then(snap => {
                if (snap.exists() && snap.data().items?.includes(productId)) {
                    alertBtn?.classList.add('active');
                }
            });
        }
    });
</script>

<style is:global>
    /* CSS Essencial para os bot√µes funcionarem visualmente */
    .icon-btn .icon-filled { display: none; }
    .icon-btn .icon-outline { display: block; }

    .icon-btn.active .icon-filled { display: block; color: #ff4757; }
    .icon-btn.active .icon-outline { display: none; }
    
    .icon-btn.active#btn-alert .icon-filled { color: #ffa502; }
</style>