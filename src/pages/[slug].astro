---
export const prerender = false;

import { createClient } from '@supabase/supabase-js';
import Layout from "../layouts/MainLayout.astro";
import Global from '../components/global.astro';
import Seo from "../../public/lib/seo/metadada.astro";

const { slug } = Astro.params;

// 1. LÓGICA DE EXTRAÇÃO DO ID
// Divide a URL pelos traços e pega o último pedaço.
// Exemplo: se a URL for "iphone-15-promocao-8842", o idFromUrl será "8842".
const idFromUrl = slug ? slug.split('.').pop() : null;

const supabaseUrl = 'https://xsdvzxggeuetqbmpvikw.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzZHZ6eGdnZXVldHFibXB2aWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0Nzg1MTgsImV4cCI6MjA4NjA1NDUxOH0.PnP3_oo67NwR1_tLeHyDI3a9bBUi8-ZQuIFWMpOQs60'
const supabase = createClient(supabaseUrl, supabaseKey)

// 2. BUSCA PELO ID (e não mais pelo slug inteiro)
const { data: product, error } = await supabase
  .from('produtos')
  .select('*')
  .eq('id', idFromUrl) // Altera de 'slug' para 'id'
  .single();

// Tratamento de erro caso o ID não exista ou seja inválido
if (error || !product) {
    console.error("Produto não encontrado ou erro na busca:", error);
    // Opcional: Redirecionar para 404
    // return Astro.redirect('/404');
}

// O resto permanece igual, pois 'product' agora contém os dados corretos
const p = product ? {
    id: product.id,
    title: product.title || product.nome_do_produto,
    price: product.price,
    oldPrice: product.oldPrice, 
    img: product.img || (Array.isArray(product.image) ? product.image[0] : product.image),
    store: product.store,
    link: product.link,
} : {}; // Objeto vazio para evitar crash se não houver produto

// Previne erro na renderização se o produto for nulo
if (!product) {
   // Você pode retornar um fragmento vazio ou redirecionar aqui também
}

const safeId = p.id ? String(p.id).replace(/[^a-zA-Z0-9]/g, '') : '';
const heartId = `heart_${safeId}`;
const alertId = `alert_${safeId}`;
const safeTitle = p.title || "Produto";

// ... (O resto das constantes SVGS permanece idêntico)
const SVGS = {
    shop: `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-8 2a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"></path></svg>`,
    heartOutline: `<svg class="icon-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`,
    heartFilled: `<svg class="icon-filled" viewBox="0 0 24 24" fill="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`,
    bellOutline: `<svg class="icon-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`,
    bellFilled: `<svg class="icon-filled" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`,
    share: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>`,
    arrowOut: `<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>`
};
---
<Seo title={p.title} image={p.img}></Seo>

<Layout title={p.title}>
    <link rel="stylesheet" href="/styles/pages/produtos.css">
    
    <div 
        id="product-metadata" 
        style="display: none;" 
        data-id={p.id} 
        data-heart-id={heartId} 
        data-alert-id={alertId} 
        data-title={safeTitle}
    ></div>

    <div class="main-container">
        <div class="detail-card">
            <div class="img-side">
                <div class="floating-actions">
                    <button id={heartId} class="icon-btn js-wishlist-btn">
                        <Fragment set:html={SVGS.heartOutline + SVGS.heartFilled} />
                    </button>
                    <button id={alertId} class="icon-btn js-alert-btn">
                        <Fragment set:html={SVGS.bellOutline + SVGS.bellFilled} />
                    </button>
                    <button class="icon-btn js-share-btn">
                        <Fragment set:html={SVGS.share} />
                    </button>
                </div>
                <img src={p.img} alt={p.title} />
            </div>

            <div class="info-side">
                <span class="store-tag"><Fragment set:html={SVGS.shop} /> {p.store}</span>
                <h1>{p.title}</h1>
                <div class="price-wrapper">
                    {p.oldPrice && <span class="old-price">R$ {p.oldPrice}</span>}
                    <div class="price-tag"><span>R$</span> {p.price}</div>
                </div>
                <a href={p.link} target="_blank" class="cta-button">
                    Ir para a Loja <Fragment set:html={SVGS.arrowOut} />
                </a>
            </div>
        </div>
    </div>

    <Global />
</Layout>

<script>
    // No Astro, imports dentro de <script> funcionam nativamente.
    // Dica: Seria melhor instalar via npm (npm install firebase), 
    // mas mantendo seu padrão de URL por enquanto:
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. RECUPERAR DADOS DO HTML
    const metaEl = document.getElementById('product-metadata');
    if (!metaEl) throw new Error("Metadata não encontrada");

    const { id: productId, heartId, alertId, title: productTitle } = metaEl.dataset;

    const firebaseConfig = {
        apiKey: "AIzaSyAltYkTpdrIShVv7wJXsszQqvOZXTC45Wg",
        authDomain: "baudepromocao-oficial.firebaseapp.com",
        projectId: "baudepromocao-oficial",
        storageBucket: "baudepromocao-oficial.firebasestorage.app",
        messagingSenderId: "743146859125",
        appId: "1:743146859125:web:6d1f5331e22b8ce981263c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Funções
    function showToast(msg) {
        const toast = document.getElementById('toast-box');
        if (!toast) { console.log(msg); return; }
        toast.textContent = msg; 
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    async function toggleCollection(collectionName, pId, elementId, activeClass, successMsg, removedMsg) {
        if (!auth.currentUser) {
            const modal = document.getElementById('login-modal');
            if(modal) modal.style.display = 'flex';
            return;
        }
        
        const btn = document.getElementById(elementId);
        const userRef = doc(db, collectionName, auth.currentUser.uid);
        const wasActive = btn?.classList.contains(activeClass);

        btn?.classList.toggle(activeClass);

        try {
            const snap = await getDoc(userRef);
            if (!wasActive) {
                if (!snap.exists()) {
                    await setDoc(userRef, { email: auth.currentUser.email, items: [String(pId)], updatedAt: new Date() });
                } else {
                    await updateDoc(userRef, { items: arrayUnion(String(pId)) });
                }
                showToast(successMsg);
            } else {
                await updateDoc(userRef, { items: arrayRemove(String(pId)) });
                showToast(removedMsg);
            }
        } catch (e) {
            btn?.classList.toggle(activeClass); 
            showToast("Erro ao processar.");
        }
    }

    // Listeners
    document.querySelector('.js-wishlist-btn')?.addEventListener('click', () => {
        toggleCollection('wishlists', productId, heartId, 'active', 'Salvo!', 'Removido.');
    });

    document.querySelector('.js-alert-btn')?.addEventListener('click', () => {
        toggleCollection('alerts', productId, alertId, 'active', 'Alerta ativado!', 'Alerta removido.');
    });

    document.querySelector('.js-share-btn')?.addEventListener('click', () => {
        const url = window.location.href;
        if (navigator.share) {
            navigator.share({ title: productTitle, url }).catch(() => {});
        } else {
            navigator.clipboard.writeText(url);
            showToast('Link copiado!');
        }
    });

    onAuthStateChanged(auth, async (user) => { 
        if(user) {
            // Check wishlist
            const wSnap = await getDoc(doc(db, "wishlists", user.uid));
            if (wSnap.exists() && wSnap.data().items?.includes(String(productId))) {
                document.getElementById(heartId)?.classList.add('active');
            }
            // Check alerts
            const aSnap = await getDoc(doc(db, "alerts", user.uid));
            if (aSnap.exists() && aSnap.data().items?.includes(String(productId))) {
                document.getElementById(alertId)?.classList.add('active');
            }
        }
    });
</script>