---
import { createClient } from "@supabase/supabase-js";

// 1. Configuração do Cliente Supabase
// Certifique-se de ter essas variáveis no seu arquivo .env
const supabaseUrl = "https://xsdvzxggeuetqbmpvikw.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzZHZ6eGdnZXVldHFibXB2aWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0Nzg1MTgsImV4cCI6MjA4NjA1NDUxOH0.PnP3_oo67NwR1_tLeHyDI3a9bBUi8-ZQuIFWMpOQs60";
const supabase = createClient(supabaseUrl, supabaseKey);

// 2. Captura o parâmetro 'id' da rota (o nome do arquivo é [id].astro)
const { id } = Astro.params;

// Validação simples para evitar chamadas desnecessárias
if (!id) {
  return Astro.redirect('/404');
}

// 3. Busca no Supabase
// Substitua 'produtos' pelo nome da sua tabela
// Substitua 'slug' pelo nome da sua coluna (slug_do_produto_coluna)
const { data, error } = await supabase
  .from('produtos') 
  .select('slug') // Selecionamos apenas o slug, pois já temos o ID
  .eq('id', id)
  .single();

// 4. Tratamento de Erro (Produto não encontrado)
if (error || !data) {
  console.error("Erro ao buscar produto ou ID inexistente:", error);
  return Astro.redirect('/404'); // Redireciona para página de erro
}

// 5. Construção da URL de Destino
// Estrutura pedida: meusite.com/slug_do_produto_coluna/a/id_do_produto
const targetUrl = `/${data.slug}/p/${id}`;

// 6. Executa o Redirecionamento (Código 302 temporário ou 301 permanente)
return Astro.redirect(targetUrl, 302); 
---

<html>
  <head>
    <title>Redirecionando...</title>
    <meta http-equiv="refresh" content={`0;url=${targetUrl}`} />
  </head>
  <body>
    <p>Redirecionando para o produto...</p>
  </body>
</html>